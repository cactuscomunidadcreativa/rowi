generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String      @id @default(cuid())
  name             String?
  email            String      @unique
  emails           UserEmail[]
  emailVerified    DateTime?
  image            String?
  bio              String?
  headline         String?
  planExpiresAt    DateTime?
  active           Boolean     @default(true)
  allowAI          Boolean     @default(true)
  contributeToRowiverse Boolean @default(true)  // Auto-contribuir data EQ al RowiVerse global
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  planId           String?
  primaryTenantId  String?
  organizationRole String?     @default("VIEWER")

  // üöÄ Onboarding y estado del usuario
  onboardingStatus OnboardingStatus @default(REGISTERED)
  onboardingStep   Int              @default(0)        // Paso actual del onboarding
  onboardingData   Json?                               // Datos temporales del onboarding
  seiRequested     Boolean          @default(false)    // ¬øSolicit√≥ tomar el SEI?
  seiRequestedAt   DateTime?                           // Fecha de solicitud del SEI
  seiCompletedAt   DateTime?                           // Fecha de completado del SEI
  seiExternalId    String?                             // ID externo en Six Seconds
  trialStartedAt   DateTime?                           // Inicio del trial
  trialEndsAt      DateTime?                           // Fin del trial

  // üîê SSO Six Seconds Integration
  ssoProvider      String?                             // "six-seconds" | null
  ssoProviderId    String?                             // ID √∫nico del usuario en el SSO
  preferredLang    String?          @default("es")     // Idioma preferido del SSO

  // üí≥ Stripe
  stripeCustomerId     String?   @unique              // ID del cliente en Stripe
  stripeSubscriptionId String?                        // ID de la suscripci√≥n activa

  // üåç Identidad Global para RowiVerse (idioma, pa√≠s, etc.)
  country  String? @default("Unknown") // pa√≠s del usuario
  region   String? // estado o regi√≥n
  city     String? // ciudad
  language String? @default("es") // idioma preferido (ISO 639-1)
  timezone String? @default("America/Lima") // zona horaria
  lat      Float? // latitud (opcional, para mapa)
  lng      Float? // longitud (opcional, para mapa)

  // üîπ Vinculaci√≥n global con RowiVerseUser
  rowiverseId String?        @unique
  rowiverse   RowiVerseUser? @relation("UserRowiVerseLink")

  // üîπ Relaciones existentes
  accounts              Account[]
  activityLogs          ActivityLog[]         @relation("UserActivityLogs")
  affinityInteractions  AffinityInteraction[]
  affinitySnapshots     AffinitySnapshot[]
  affinityProfile       AffinityProfile?
  auditLogs             AuditLog[]            @relation("AuditActor")
  auditsTargeted        AuditLog[]            @relation("AuditTarget")
  batches               Batch[]               @relation("UserBatches")
  caseStudyAuthor       CaseStudy[]           @relation("CaseStudyAuthor")
  issuedCertificates    Certificate[]         @relation("CertificateIssuedBy")
  earnedCertificates    Certificate[]         @relation("CertificateUser")
  claimedMembers        CommunityMember[]     @relation("ClaimedMembers")
  ownedMembers          CommunityMember[]     @relation("OwnerMember")
  communityMemberships  CommunityMember[]
  csvUploads            CsvUpload[]           @relation("UserCsvUploads")
  emotionalEvents       EmotionalEvent[]
  employeeProfiles      EmployeeProfile[]
  enrollments           Enrollment[]
  eqProgress            EqProgress[]
  eqSnapshots           EqSnapshot[]
  hubMemberships        HubMembership[]
  hubPosts              HubPost[]             @relation("HubPostsByUser")
  invitesSent           InviteToken[]         @relation("UserInvites")
  learningNotes         LearningNote[]
  approvals             LeaveRequest[]        @relation("LeaveApprover")
  memberships           Membership[]
  orgMemberships        OrgMembership[]
  pagesAuthored         Page[]                @relation("PagesByAuthor")
  payouts               Payout[]
  feedbacksGiven        PeerFeedback[]        @relation("PeerFeedbackGiver")
  peerFeedbacks         PeerFeedback[]        @relation("PeerFeedbackReceiver")
  reviewsAuthored       PerformanceReview[]   @relation("UserAsReviewer")
  quizAttempts          QuizAttempt[]
  peerChats             RowiChat[]            @relation("ChatPeerRelation")
  userChats             RowiChat[]            @relation("UserChats")
  authoredPosts         RowiFeed[]
  initiatedRelations    RowiRelation[]        @relation("InitiatorRelation")
  receivedRelations     RowiRelation[]        @relation("ReceiverRelation")
  sessions              Session[]
  studyGroupMemberships StudyGroupMember[]
  plan                  Plan?                 @relation(fields: [planId], references: [id])
  primaryTenant         Tenant?               @relation("UserPrimaryTenant", fields: [primaryTenantId], references: [id])
  aiControls            UserAIControl[]
  permissions           UserPermission[]
  usage                 UserUsage[]
  createdCommunities    RowiCommunity[]
  rowiCommunities       RowiCommunityUser[]
  invitedRowiUsers      RowiCommunityUser[]   @relation("RowiCommunityInviter")
  rowiCommunityPosts    RowiCommunityPost[]
  createdVerses         RowiVerse[]           @relation("UserCreatedVerses")
  EcosystemLink         EcosystemLink[]

  // ü¶â ROWI 100% - Nuevas relaciones
  avatar                AvatarEvolution?
  topPerformerMetrics   TopPerformerMetric[]
  emotionalROI          EmotionalROI[]
  decisionTracking      DecisionTracking[]
  integrationConnections IntegrationConnection[]
  calendarEvents        CalendarEvent[]
  notificationQueue     NotificationQueue[]

  // üéÆ Gamificaci√≥n
  achievements          UserAchievement[]
  points                UserPoints[]
  streak                UserStreak?
  level                 UserLevel?
  rewards               UserReward[]
  microLearningProgress UserMicroLearning[]

  // üìÖ WeekFlow
  weekFlowContributions WeekFlowContribution[]
  weekFlowMoodCheckins  WeekFlowMoodCheckin[]
  weekFlowComments      WeekFlowComment[]
  rowiTasks             RowiTask[]
  taskReflections       TaskReflection[]
  emotionVocabulary     EmotionVocabulary?

  @@map("user")
}

/// üìß Correos secundarios del usuario
model UserEmail {
  id        String   @id @default(cuid())
  userId    String
  email     String
  label     String? // work | personal | alt
  verified  Boolean  @default(false)
  primary   Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, email])
  @@map("user_email")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  access_token      String?
  refresh_token     String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("account")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model UserPermission {
  id     String @id @default(cuid())
  userId String

  // ‚úÖ Nuevos (compatibles)
  scopeType PermissionScope? // temporalmente opcional
  scopeId   String? // id del objeto seg√∫n scopeType (puede ser null para rowiverse)

  role      String
  grantedAt DateTime @default(now())

  // üîÅ Legacy (se eliminar√°n en Fase 2)
  tenantId String?
  scope    String  @default("global")

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, tenantId])
  @@index([userId, scopeType, scopeId])
  @@map("user_permission")
}

/// =========================================================
/// üéõÔ∏è PROFILE FEATURE ‚Äî Features visibles por perfil/rol
/// =========================================================
/// Define qu√© features/secciones puede ver cada rol.
/// Permite configurar visibilidad granular en el UI.
model ProfileFeature {
  id          String   @id @default(cuid())

  // üéØ A qu√© perfil aplica
  role        String   // OrgRole o TenantRole como string
  roleType    String   @default("org") // "org" | "tenant" | "custom"

  // üì¶ Feature espec√≠fica
  featureKey  String   // ej: "benchmarks", "admin.users", "dashboard.roi"
  category    String   @default("general") // Categor√≠a para agrupar features

  // üîí Configuraci√≥n de acceso
  canView     Boolean  @default(false)
  canCreate   Boolean  @default(false)
  canEdit     Boolean  @default(false)
  canDelete   Boolean  @default(false)

  // üìù Metadata
  description String?
  priority    Int      @default(0) // Para ordenamiento

  // üïê Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // üîó Opcional: scope espec√≠fico (tenant, org, etc.)
  scopeType   String?  // "tenant" | "organization" | "global"
  scopeId     String?  // ID del scope si no es global

  @@unique([role, roleType, featureKey, scopeType, scopeId])
  @@index([role, roleType])
  @@index([featureKey])
  @@index([category])
  @@map("profile_feature")
}

/// =========================================================
/// üìã FEATURE DEFINITION ‚Äî Cat√°logo de features disponibles
/// =========================================================
/// Define todas las features posibles del sistema.
/// Sirve como cat√°logo para configurar ProfileFeature.
model FeatureDefinition {
  id           String   @id @default(cuid())
  key          String   @unique // ej: "benchmarks.stats", "admin.users.create"
  name         String   // Nombre legible
  description  String?
  category     String   @default("general")
  parentKey    String?  // Para jerarqu√≠a de features

  // üîß Configuraci√≥n
  icon         String?  // Nombre de icono lucide
  route        String?  // Ruta asociada en la app
  isAdmin      Boolean  @default(false) // Solo para admins
  isDefault    Boolean  @default(true)  // Visible por defecto para nuevos roles

  // üïê Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([parentKey])
  @@map("feature_definition")
}

/// =========================================================
/// üåé SYSTEM ‚Äî N√∫cleo Global del Ecosistema CACTUS
/// =========================================================
/// Representa la instancia ra√≠z que contiene toda la estructura
/// (SuperHubs, Hubs, Tenants, Agentes, Traducciones, etc.)
/// Permite configuraci√≥n global, branding, idioma base y pol√≠ticas.
model System {
  id             String          @id @default(cuid())
  name           String          @default("Cactus Global System")
  slug           String          @unique
  description    String?
  logo           String?         @default("/cactus-logo.png")
  primaryColor   String?         @default("#0F172A")
  secondaryColor String?         @default("#F97316")
  defaultLang    String?         @default("es")
  timezone       String?         @default("America/Lima")
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  agents         AgentConfig[]
  components     Component[]
  layouts        Layout[]
  pages          Page[]
  settings       SystemSetting[]
  tenants        Tenant[]
  translations   Translation[]
  superHubs      SuperHub[]

  @@map("system")
}

/// =========================================================
/// ‚öôÔ∏è SYSTEM SETTING ‚Äî Configuraciones y pol√≠ticas globales
/// =========================================================
/// Guarda par√°metros del sistema, l√≠mites, licencias, IA, etc.
model SystemSetting {
  id        String   @id @default(cuid())
  systemId  String
  key       String
  value     String
  type      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  system    System   @relation(fields: [systemId], references: [id], onDelete: Cascade)

  @@unique([systemId, key])
  @@index([systemId])
  @@map("system_setting")
}

/// üèõÔ∏è SuperHub ‚Äî Nodo continental o macro regi√≥n dentro del RowiVerse
/// ---------------------------------------------------------
/// Ejemplo: ‚ÄúCactus Hub Global‚Äù, ‚ÄúRowi LATAM Hub‚Äù, ‚ÄúRowi EMEA‚Äù, etc.
/// Cada SuperHub agrupa Hubs, Tenants, Organizaciones y Comunidades.
model SuperHub {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  vision      String?
  mission     String?
  colorTheme  String?
  logo        String?
  country     String? @default("Global")
  language    String? @default("es")
  region      String? @default("LATAM")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üåç Vinculaci√≥n global al RowiVerse (ra√≠z del ecosistema)
  rowiVerseId String?
  rowiVerse   RowiVerse? @relation("RowiVerseToSuperHub", fields: [rowiVerseId], references: [id], onDelete: Cascade)

  // üîó Jerarqu√≠a interna de SuperHubs
  parentHubId String?
  parentHub   SuperHub?  @relation("SuperHubHierarchy", fields: [parentHubId], references: [id])
  childHubs   SuperHub[] @relation("SuperHubHierarchy")

  // ‚öôÔ∏è V√≠nculo con el sistema base (Cactus System)
  systemId String?
  system   System? @relation(fields: [systemId], references: [id], onDelete: Cascade)

  // üí° Relaciones funcionales (componentes del entorno)
  agents       AgentConfig[]
  Component    Component[]
  Layout       Layout[]
  pages        Page[]
  rolesDynamic RoleDynamic[]
  insights     InsightRecord[]
  knowledge    KnowledgeResource[]
  forecasts    PredictiveMetric[]  @relation("SuperHubForecasts")

  // üß© Jerarqu√≠a descendente (relaciones nombradas para evitar ambig√ºedad)
  hubs          Hub[]           @relation("SuperHubToHub")
  tenants       Tenant[]        @relation("SuperHubToTenant")
  organizations Organization[]  @relation("SuperHubToOrganization")
  communities   RowiCommunity[] @relation("SuperHubToCommunity")

  @@index([name])
  @@index([slug])
  @@index([rowiVerseId])
  @@map("super_hub")
}

/// üß± Hub ‚Äî Nodo operativo dentro del Tenant
/// ---------------------------------------------------------
/// Ejemplo: ‚ÄúRowi Per√∫ Hub‚Äù, ‚ÄúEQ LATAM Hub‚Äù, ‚ÄúCactus Hub‚Äù
/// Un Hub pertenece a un Tenant y puede estar asociado a un SuperHub.
model Hub {
  id          String   @id @default(cuid())
  tenantId    String
  superHubId  String?
  name        String
  slug        String   @unique
  description String?
  themeColor  String?
  visibility  String?  @default("private")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // üåç Jerarqu√≠a superior
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  superHub SuperHub? @relation("SuperHubToHub", fields: [superHubId], references: [id])

  // üë• Relaciones internas
  communityMembers  CommunityMember[]
  memberships       HubMembership[]
  roles             HubRoleDynamic[]
  posts             HubPost[]
  rolesDynamic      RoleDynamic[]
  costLinks         CostCenterLink[]
  agents            AgentConfig[]
  emotionalEngines  EmotionalAIEngine[]
  invoices          Invoice[]
  predictiveMetrics PredictiveMetric[]
  projects          Project[]
  transactions      Transaction[]
  insights          InsightRecord[]
  knowledge         KnowledgeResource[]

  // üîó Relaciones con Organizaciones y Comunidades
  organizations Organization[]  @relation("HubToOrganization")
  communities   RowiCommunity[] @relation("HubToCommunity")

  // üîó Join Table para relaci√≥n n:m con Organization (relaci√≥n nombrada)
  organizationLinks OrganizationToHub[] @relation("HubToOrganizationLink")

  // ü¶â ROWI 100% - Nuevas relaciones
  collectivePatterns CollectivePattern[]
  emotionalROI       EmotionalROI[]

  // üìä Benchmarks vinculados a este Hub
  benchmarks Benchmark[] @relation("HubToBenchmark")

  // üìÖ WeekFlow
  weekFlowConfigs  WeekFlowConfig[]
  weekFlowSessions WeekFlowSession[]
  rowiTasks        RowiTask[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([slug])
  @@index([superHubId])
  @@map("hub")
}

model HubMembership {
  id       String          @id @default(cuid())
  hubId    String
  userId   String
  roleId   String?
  access   String?
  joinedAt DateTime        @default(now())
  hub      Hub             @relation(fields: [hubId], references: [id], onDelete: Cascade)
  role     HubRoleDynamic? @relation(fields: [roleId], references: [id])
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([hubId, userId])
  @@index([hubId, roleId])
  @@map("hub_membership")
}

model HubRoleDynamic {
  id          String          @id @default(cuid())
  hubId       String
  name        String
  permissions Json?
  color       String?
  icon        String?
  createdAt   DateTime        @default(now())
  memberships HubMembership[]
  hub         Hub             @relation(fields: [hubId], references: [id], onDelete: Cascade)

  @@unique([hubId, name])
  @@map("hub_role_dynamic")
}

model HubPost {
  id         String   @id @default(cuid())
  hubId      String
  authorId   String
  content    String
  emotionTag String?
  intent     String?
  visibility String?  @default("hub")
  createdAt  DateTime @default(now())
  author     User     @relation("HubPostsByUser", fields: [authorId], references: [id], onDelete: Cascade)
  hub        Hub      @relation(fields: [hubId], references: [id], onDelete: Cascade)

  @@index([hubId, createdAt])
  @@map("hub_post")
}

/// üß± Tenant ‚Äî Entidad operativa o espacio dentro del ecosistema RowiVerse
/// ---------------------------------------------------------
/// Ejemplo: ‚ÄúRowi Master‚Äù, ‚ÄúEQ LATAM Network‚Äù, ‚ÄúCactus Per√∫‚Äù
/// Los Tenants pertenecen a un SuperHub y pueden tener comunidades, hubs y organizaciones.
/// üß± Tenant ‚Äî Entidad operativa o espacio dentro del ecosistema RowiVerse
model Tenant {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  billingEmail    String?
  visibilityScope String?
  emotionalAccess Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // üîó Jerarqu√≠a superior
  rowiVerseId String?
  superHubId  String?
  planId      String?
  systemId    String?

  // üåç Relaciones jer√°rquicas
  rowiVerse RowiVerse? @relation("RowiVerseToTenant", fields: [rowiVerseId], references: [id], onDelete: Cascade)
  superHub  SuperHub?  @relation("SuperHubToTenant", fields: [superHubId], references: [id], onDelete: Cascade)
  system    System?    @relation(fields: [systemId], references: [id], onDelete: Cascade)

  // üí° Relaciones funcionales internas
  agents              AgentConfig[]
  analytics           AnalyticsSnapshot[]
  assets              Asset[]
  communityMembers    CommunityMember[]
  Component           Component[]
  costCenters         CostCenter[]
  courses             Course[]
  emotionalEngines    EmotionalAIEngine[]
  employees           EmployeeProfile[]
  externalConnections ExternalConnection[]
  invites             InviteToken[]        @relation("TenantInvites")
  invoices            Invoice[]
  Layout              Layout[]
  members             Membership[]
  pages               Page[]
  payouts             Payout[]
  payrollRuns         PayrollRun[]
  forecasts           PredictiveMetric[]
  products            Product[]
  projects            Project[]
  purchaseOrders      PurchaseOrder[]
  rolesDynamic        RoleDynamic[]
  salesOrders         SalesOrder[]
  plan                Plan?                @relation(fields: [planId], references: [id])
  modules             TenantModule[]
  transactions        Transaction[]
  translations        Translation[]
  usageDaily          UsageDaily[]
  primaryUsers        User[]               @relation("UserPrimaryTenant")
  permissions         UserPermission[]
  UserUsage           UserUsage[]
  warehouses          Warehouse[]
  webhooks            Webhook[]
  hubs                Hub[]
  insights            InsightRecord[]
  knowledge           KnowledgeResource[]
  emotionalConfigs    EmotionalConfig[]    @relation("TenantToEmotionalConfig")

  // üë• Comunidades vinculadas a este Tenant
  rowiCommunities RowiCommunity[] @relation("TenantToCommunity")

  // üß© Relaciones N:M con organizaciones (multi-tenant)
  organizationLinks OrganizationToTenant[] @relation("TenantToOrganizationLink")

  // ü¶â ROWI 100% - Nuevas relaciones
  topPerformerMetrics    TopPerformerMetric[]
  collectivePatterns     CollectivePattern[]
  emotionalROI           EmotionalROI[]
  decisionTracking       DecisionTracking[]
  integrationConnections IntegrationConnection[]
  tenantBranding         TenantBranding?
  notificationQueue      NotificationQueue[]

  // üìä Benchmarks vinculados a este Tenant
  benchmarks Benchmark[] @relation("TenantToBenchmark")

  // üìÖ WeekFlow
  weekFlowConfigs  WeekFlowConfig[]
  weekFlowSessions WeekFlowSession[]
  rowiTasks        RowiTask[]

  @@index([name])
  @@index([slug])
  @@index([rowiVerseId])
  @@index([superHubId])
  @@map("tenant")
}

model Plan {
  id           String   @id @default(cuid())
  name         String   @unique
  slug         String?  @unique          // "free", "plus", "family", "pro", "business", "enterprise"
  description  String?
  descriptionEN String?                   // Descripci√≥n en ingl√©s
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // üí∞ Precios
  priceUsd          Float    @default(0)      // Precio mensual USD
  priceCents        Int      @default(0)      // Precio mensual en centavos para Stripe
  priceYearlyUsd    Float    @default(0)      // Precio anual USD
  priceYearlyCents  Int      @default(0)      // Precio anual en centavos para Stripe
  currency          String   @default("USD")  // Moneda principal
  billingPeriod     String   @default("monthly") // "monthly" | "yearly" | "custom"

  // üí≥ Stripe
  stripePriceIdMonthly String?           // ID precio mensual Stripe
  stripePriceIdYearly  String?           // ID precio anual Stripe
  stripeProductId      String?           // ID del producto en Stripe

  // üéÅ Trial
  trialDays           Int      @default(0)   // D√≠as de trial (0 = sin trial)
  durationDays        Int      @default(30)  // Duraci√≥n del plan

  // ü§ñ Tokens IA
  tokensMonthly       Int      @default(0)    // Tokens IA mensuales incluidos
  tokensShared        Boolean  @default(false) // Tokens compartidos entre usuarios
  tokensPerUser       Boolean  @default(true)  // Tokens por usuario individual
  tokensOrganization  Int      @default(0)    // Tokens para la organizaci√≥n (Business/Enterprise)

  // üë• Usuarios y miembros
  maxUsers            Int      @default(1)      // Usuarios m√°ximos (individual: 1, family: 6, etc.)
  minUsers            Int      @default(1)      // Usuarios m√≠nimos (Business: 20)
  pricePerUserMonthly Float    @default(0)      // Precio por usuario adicional/mes
  pricePerUserYearly  Float    @default(0)      // Precio por usuario adicional/a√±o
  allowFamilyMembers  Boolean  @default(false)  // Permite agregar familiares

  // üè¢ Tipo de plan
  planType            String   @default("individual") // "individual" | "family" | "team" | "business" | "enterprise"
  targetAudience      String?                         // "B2C" | "B2B" | "B2C/B2B"

  // üß† Features - IA y Asistentes
  aiEnabled           Boolean  @default(true)
  superRowiAccess     Boolean  @default(false)  // Acceso a Super Rowi
  rowiEQAccess        Boolean  @default(false)  // Acceso a Rowi EQ
  rowiAffinityAccess  Boolean  @default(false)  // Acceso a Rowi Affinity
  rowiECOAccess       Boolean  @default(false)  // Acceso a Rowi ECO
  rowiTrainerAccess   Boolean  @default(false)  // Acceso a Rowi Trainer
  rowiSalesAccess     Boolean  @default(false)  // Acceso a Rowi Sales

  // üß† Features - SEI y Assessment
  seiIncluded         Boolean  @default(false)  // SEI incluido en el precio
  seiAnnual           Boolean  @default(false)  // SEI anual incluido
  brainBriefIncluded  Boolean  @default(false)  // Brain Brief Profile incluido
  seiDiscountPercent  Int      @default(0)      // % descuento en SEI

  // üß† Features - Comunidades y grupos
  maxCommunities      Int      @default(1)      // Comunidades m√°ximas
  maxMembers          Int      @default(10)     // Miembros por comunidad
  privateGroups       Boolean  @default(false)  // Grupos privados

  // üß† Features - Reportes y Analytics
  benchmarkAccess     Boolean  @default(false)  // Acceso a benchmarks
  advancedReports     Boolean  @default(false)  // Reportes avanzados
  executiveDashboard  Boolean  @default(false)  // Dashboard ejecutivo
  benchmarkingSectorial Boolean @default(false) // Benchmarking sectorial

  // üß† Features - Integraciones
  apiAccess           Boolean  @default(false)  // Acceso a API
  slackIntegration    Boolean  @default(false)  // Integraci√≥n Slack
  teamsIntegration    Boolean  @default(false)  // Integraci√≥n MS Teams
  gmailIntegration    Boolean  @default(false)  // Integraci√≥n Gmail/Google

  // üß† Features - Soporte
  supportLevel        String   @default("community") // "community" | "email" | "chat" | "priority" | "dedicated"
  customOnboarding    Boolean  @default(false)  // Onboarding personalizado
  workshopIncludes    Boolean  @default(false)  // Workshops de adopci√≥n

  // üìÖ Features - WeekFlow
  weekflowAccess      Boolean  @default(false)  // Acceso a WeekFlow
  maxWeekflows        Int      @default(0)      // M√°ximo de WeekFlows (0 = ilimitado)
  weekflowInsights    Boolean  @default(false)  // Insights emocionales avanzados

  // üè∑Ô∏è Display
  badge               String?           // "Popular", "Best Value", "Recomendado", etc.
  badgeEN             String?           // Badge en ingl√©s
  emoji               String?           // Emoji del plan
  color               String?           // Color del plan (hex)
  icon                String?           // Icono (lucide icon name)
  sortOrder           Int      @default(0)
  isPublic            Boolean  @default(true)   // Visible en pricing page
  isActive            Boolean  @default(true)
  isCustomPricing     Boolean  @default(false)  // Precio personalizado (Enterprise)

  // üìù Features JSON (para caracter√≠sticas adicionales)
  features            Json?             // Lista de features adicionales
  featuresEN          Json?             // Features en ingl√©s
  limitations         Json?             // Limitaciones del plan
  limitationsEN       Json?             // Limitaciones en ingl√©s

  // Relaciones
  memberships Membership[]
  users       User[]
  tenants     Tenant[]
  RoleDynamic RoleDynamic[]

  @@map("plan")
}

/// üè¢ Organizaci√≥n dentro del ecosistema RowiVerse
/// ---------------------------------------------------------
/// Ejemplo: ‚ÄúTeleperformance LATAM‚Äù, ‚ÄúEQ LATAM Network‚Äù, ‚ÄúCactus Academy‚Äù
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // üîó V√≠nculos jer√°rquicos (legacy)
  rowiVerseId String?
  superHubId  String?
  hubId       String?

  // üè¢ NUEVO: Jerarqu√≠a de organizaciones
  // Six Seconds ‚Üí LATAM/EMEA/APAC ‚Üí Coaches/Staff ‚Üí Clients
  parentId           String?
  unitType           OrgUnitType     @default(TEAM)
  inheritPermissions Boolean         @default(true)  // Heredar permisos del padre
  level              Int             @default(0)     // Nivel en √°rbol (0=ra√≠z)

  // üß≠ Relaciones jer√°rquicas (todas con nombres expl√≠citos)
  rowiVerse RowiVerse? @relation("RowiVerseToOrganization", fields: [rowiVerseId], references: [id], onDelete: Cascade)
  superHub  SuperHub?  @relation("SuperHubToOrganization", fields: [superHubId], references: [id], onDelete: Cascade)
  hub       Hub?       @relation("HubToOrganization", fields: [hubId], references: [id], onDelete: Cascade)

  // üå≤ NUEVO: Self-relation para jerarqu√≠a padre/hijos
  parent   Organization?  @relation("OrgHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Organization[] @relation("OrgHierarchy")

  // üë• Relaciones organizativas
  members OrgMembership[]

  // üí° Relaciones funcionales internas
  agents     AgentConfig[]
  components Component[]
  layouts    Layout[]
  pages      Page[]

  // üåê Relaciones N:M con Hubs, Tenants y Comunidades
  hubLinks        OrganizationToHub[]    @relation("OrganizationToHubLink")
  tenantLinks     OrganizationToTenant[] @relation("OrganizationToTenantLink")
  rowiCommunities RowiCommunity[]        @relation("OrganizationToCommunity")

  // üìä Benchmarks vinculados a esta Organizaci√≥n
  benchmarks Benchmark[] @relation("OrganizationToBenchmark")

  @@index([rowiVerseId])
  @@index([superHubId])
  @@index([hubId])
  @@index([parentId])
  @@index([unitType])
  @@map("organization")
}

/// üîó Relaci√≥n intermedia: Organizaci√≥n ‚Üî Hub
/// ---------------------------------------------------------
/// Permite que una organizaci√≥n est√© vinculada a uno o varios hubs.
/// Ejemplo: ‚ÄúTeleperformance LATAM‚Äù ‚Üí vinculado a ‚ÄúHub Per√∫‚Äù y ‚ÄúHub Colombia‚Äù.
model OrganizationToHub {
  hubId          String
  organizationId String

  // üîó Relaciones con entidades principales
  hub          Hub          @relation("HubToOrganizationLink", fields: [hubId], references: [id], onDelete: Cascade)
  organization Organization @relation("OrganizationToHubLink", fields: [organizationId], references: [id], onDelete: Cascade)

  // üîí Clave primaria compuesta
  @@id([hubId, organizationId], map: "OrganizationToHub_pkey")
  // ‚öôÔ∏è √çndices
  @@index([organizationId], map: "OrganizationToHub_org_idx")
  // üß≠ Nombre legible en BD
  @@map("organization_to_hub")
}

model OrganizationToTenant {
  tenantId       String
  organizationId String

  // üîó Relaciones con entidades principales
  tenant       Tenant       @relation("TenantToOrganizationLink", fields: [tenantId], references: [id], onDelete: Cascade)
  organization Organization @relation("OrganizationToTenantLink", fields: [organizationId], references: [id], onDelete: Cascade)

  // üîí Clave primaria compuesta
  @@id([tenantId, organizationId], map: "OrganizationToTenant_pkey")
  // ‚öôÔ∏è √çndices
  @@index([organizationId], map: "OrganizationToTenant_org_idx")
  // üß≠ Nombre legible en BD
  @@map("organization_to_tenant")
}

model OrgMembership {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole      @default(MEMBER)
  tokenQuota     Int?         @default(0)
  tokenUsed      Int?         @default(0)
  status         String       @default("active")
  joinedAt       DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId, role])
  @@map("org_membership")
}

model Membership {
  id         String     @id @default(cuid())
  userId     String
  tenantId   String
  planId     String?
  role       TenantRole @default(VIEWER)
  tokenQuota Int?       @default(0)
  tokenUsed  Int?       @default(0)
  notes      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  plan       Plan?      @relation(fields: [planId], references: [id])
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId, role])
  @@map("membership")
}

/// *
/// * =========================================================
/// * ü´Ç COMMUNITY MEMBER ‚Äî Miembros de la comunidad o hub
/// * =========================================================
/// * Representa una persona o identidad dentro de un Hub o Tenant.
/// * Puede ser reclamada por un usuario real o existir como miembro simb√≥lico.
model CommunityMember {
  id             String                @id @default(cuid())
  name           String?
  role           String?
  status         CommunityMemberStatus @default(ACTIVE)
  tenantId       String
  hubId          String?
  userId         String?
  ownerId        String?
  claimedById    String?
  joinedAt       DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  brainStyle     String?
  closeness      String?
  connectionType String?
  country        String?
  email          String?               @unique
  firstName      String?
  group          String?
  lastName       String?
  source         String?               @default("manual")

  // üîó Nueva conexi√≥n global
  rowiverseUserId String? // ‚úÖ ID global del RowiVerseUser
  rowiverseUser   RowiVerseUser? @relation(fields: [rowiverseUserId], references: [id]) // ‚úÖ Relaci√≥n global

  affinityInteractions AffinityInteraction[]
  affinitySnapshots    AffinitySnapshot[]
  claimedBy            User?                 @relation("ClaimedMembers", fields: [claimedById], references: [id])
  hub                  Hub?                  @relation(fields: [hubId], references: [id])
  owner                User?                 @relation("OwnerMember", fields: [ownerId], references: [id])
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                 User?                 @relation(fields: [userId], references: [id])
  emotions             EmotionalEvent[]
  progress             EqProgress[]
  snapshots            EqSnapshot[]

  @@index([tenantId])
  @@index([hubId])
  @@index([userId])
  @@index([email])
  @@index([firstName])
  @@index([lastName])
  @@index([rowiverseUserId]) // ‚úÖ √≠ndice global
  @@map("community_member")
}

model RowiRelation {
  id                String   @id @default(cuid())
  initiatorId       String
  receiverId        String
  initiatorGlobalId String? // üîó RowiVerseUser del iniciador
  receiverGlobalId  String? // üîó RowiVerseUser del receptor
  type              String   @default("connection")
  strength          Float?
  context           String?
  status            String   @default("active")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones locales (usuario dentro de tenant/hub)
  initiator User @relation("InitiatorRelation", fields: [initiatorId], references: [id], onDelete: Cascade)
  receiver  User @relation("ReceiverRelation", fields: [receiverId], references: [id], onDelete: Cascade)

  // üîó Relaciones globales (persona dentro del RowiVerse)
  initiatorGlobal RowiVerseUser? @relation("GlobalInitiatorRelation", fields: [initiatorGlobalId], references: [id])
  receiverGlobal  RowiVerseUser? @relation("GlobalReceiverRelation", fields: [receiverGlobalId], references: [id])

  @@unique([initiatorId, receiverId])
  @@index([type, status])
  @@index([initiatorGlobalId, receiverGlobalId])
  @@map("rowi_relation")
}

model RowiFeed {
  id         String   @id @default(cuid())
  authorId   String
  content    String
  mood       String?
  visibility String   @default("public")
  likes      Int      @default(0)
  comments   Int      @default(0)
  tags       String[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@map("rowi_feed")
}

/// =========================================================
/// üß† EQ SNAPSHOT 2.0 ‚Äî Compatible con datasets Six Seconds
/// =========================================================
model EqSnapshot {
  id                      String   @id @default(cuid())
  userId                  String?
  memberId                String?
  rowiverseUserId         String? // üîó identidad global RowiVerseUser
  dataset                 String
  project                 String?
  owner                   String?
  country                 String?
  email                   String?
  jobFunction             String?
  jobRole                 String?
  sector                  String?
  age                     Int?
  gender                  String?
  education               String?
  phone                   String?
  context                 String?
  at                      DateTime @default(now())
  K                       Int?
  C                       Int?
  G                       Int?
  EL                      Int?
  RP                      Int?
  ACT                     Int?
  NE                      Int?
  IM                      Int?
  OP                      Int?
  EMP                     Int?
  NG                      Int?
  brainStyle              String?
  overall4                Float?
  recentMood              String?
  moodIntensity           String?
  reliabilityIndex        Float?
  positiveImpressionScore Float?
  positiveImpressionRange String?
  executionTimeRange      String?
  randomIndex             Float?
  densityIndex            Float?
  answerStyle             String?
  normFactorComplement    Float?
  consistencyOutput       Float?

  competencies  EqCompetencySnapshot[]
  moods         EqMoodSnapshot[]
  outcomes      EqOutcomeSnapshot[]
  progress      EqProgress[]              @relation("ProgressBySnapshot")
  member        CommunityMember?          @relation(fields: [memberId], references: [id], onDelete: Cascade)
  user          User?                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rowiverseUser RowiVerseUser?            @relation(fields: [rowiverseUserId], references: [id]) // ‚úÖ nueva relaci√≥n global
  subfactors    EqSubfactorSnapshot[]
  success       EqSuccessFactorSnapshot[]
  values        EqValueSnapshot[]
  talents       TalentSnapshot[]

  @@index([userId])
  @@index([memberId])
  @@index([dataset])
  @@index([email])
  @@index([rowiverseUserId]) // ‚úÖ √≠ndice global
  @@map("eq_snapshot")
}

model EqCompetencySnapshot {
  id         String     @id @default(cuid())
  snapshotId String
  key        String
  label      String?
  score      Float?
  snapshot   EqSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("eq_competency_snapshot")
}

model EqOutcomeSnapshot {
  id         String     @id @default(cuid())
  snapshotId String
  key        String
  label      String?
  score      Float?
  snapshot   EqSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("eq_outcome_snapshot")
}

model EqSubfactorSnapshot {
  id         String     @id @default(cuid())
  snapshotId String
  key        String
  label      String?
  score      Float?
  snapshot   EqSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("eq_subfactor_snapshot")
}

model EqValueSnapshot {
  id         String     @id @default(cuid())
  snapshotId String
  key        String
  label      String?
  score      Float?
  snapshot   EqSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("eq_value_snapshot")
}

model EqSuccessFactorSnapshot {
  id         String     @id @default(cuid())
  snapshotId String
  key        String
  label      String?
  score      Float?
  snapshot   EqSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("eq_success_factor_snapshot")
}

model TalentSnapshot {
  id         String     @id @default(cuid())
  snapshotId String
  key        String
  label      String?
  score      Float?
  snapshot   EqSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("talent_snapshot")
}

model EqMoodSnapshot {
  id         String     @id @default(cuid())
  snapshotId String
  mood       String
  intensity  Float?
  valence    Float?
  snapshot   EqSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@map("eq_mood_snapshot")
}

model EqProgress {
  id          String           @id @default(cuid())
  userId      String?
  memberId    String?
  snapshotId  String?
  reflection  String?
  insight     String?
  actionPlan  String?
  metrics     Json?
  contextType String?
  contextId   String?
  mood        String?
  createdAt   DateTime         @default(now())
  events      EmotionalEvent[] @relation("ProgressEvents")
  member      CommunityMember? @relation(fields: [memberId], references: [id])
  snapshot    EqSnapshot?      @relation("ProgressBySnapshot", fields: [snapshotId], references: [id])
  user        User?            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([memberId])
  @@index([contextType, contextId])
  @@map("eq_progress")
}

model RowiChat {
  id          String           @id @default(cuid())
  userId      String?
  peerId      String?
  agentId     String?
  role        String
  content     String
  intent      String?
  locale      String?
  sentiment   String?
  confidence  Float?
  contextType String?
  contextId   String?
  createdAt   DateTime         @default(now())
  events      EmotionalEvent[]
  peer        User?            @relation("ChatPeerRelation", fields: [peerId], references: [id])
  user        User?            @relation("UserChats", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contextType, contextId])
  @@map("rowi_chat")
}

model EmotionalEvent {
  id              String   @id @default(cuid())
  userId          String?
  memberId        String?
  rowiverseUserId String? // üîó Identidad global RowiVerseUser
  chatId          String?
  progressId      String?
  type            String
  message         String?
  contextType     String?
  contextId       String?
  intensity       Int?
  valence         Float?
  aiModel         String?
  metadata        Json?
  createdAt       DateTime @default(now())

  // Relaciones existentes
  chat     RowiChat?        @relation(fields: [chatId], references: [id])
  member   CommunityMember? @relation(fields: [memberId], references: [id])
  progress EqProgress?      @relation("ProgressEvents", fields: [progressId], references: [id])
  user     User?            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // üîπ Nueva relaci√≥n global
  rowiverseUser RowiVerseUser? @relation(fields: [rowiverseUserId], references: [id])

  @@index([userId])
  @@index([memberId])
  @@index([type])
  @@index([contextType, contextId])
  @@index([rowiverseUserId]) // ‚úÖ Nuevo √≠ndice global
  @@map("emotional_event")
}

model Batch {
  id          String    @id @default(cuid())
  ownerId     String?
  type        String
  context     String?
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?
  status      String
  result      Json?
  meta        Json?
  count       Int?      @default(0)
  description String?
  name        String
  owner       User?     @relation("UserBatches", fields: [ownerId], references: [id])

  @@index([ownerId])
  @@index([type])
  @@index([context])
  @@map("batch")
}

model CaseStudy {
  id        String              @id @default(cuid())
  authorId  String
  title     String
  summary   String?
  context   String?
  tags      String[]
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  sections  CaseSection[]
  author    User                @relation("CaseStudyAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  notes     LearningNote[]
  feedback  PeerFeedback[]
  resources KnowledgeResource[] @relation("CaseStudyResources")
  groups    StudyGroup[]        @relation("CaseStudyToStudyGroup")

  @@map("case_study")
}

model CaseSection {
  id        String    @id @default(cuid())
  caseId    String
  heading   String
  content   String?
  order     Int       @default(0)
  caseStudy CaseStudy @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@map("case_section")
}

model LearningNote {
  id         String     @id @default(cuid())
  caseId     String?
  userId     String
  title      String?
  body       String?
  visibility String?    @default("private")
  createdAt  DateTime   @default(now())
  caseStudy  CaseStudy? @relation(fields: [caseId], references: [id])
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("learning_note")
}

model PeerFeedback {
  id         String     @id @default(cuid())
  caseId     String?
  fromUserId String
  toUserId   String
  comment    String?
  score      Int?
  createdAt  DateTime   @default(now())
  caseStudy  CaseStudy? @relation(fields: [caseId], references: [id])
  fromUser   User       @relation("PeerFeedbackGiver", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User       @relation("PeerFeedbackReceiver", fields: [toUserId], references: [id], onDelete: Cascade)

  @@map("peer_feedback")
}

model StudyGroup {
  id        String             @id @default(cuid())
  name      String
  purpose   String?
  createdAt DateTime           @default(now())
  members   StudyGroupMember[]
  cases     CaseStudy[]        @relation("CaseStudyToStudyGroup")

  @@map("study_group")
}

model StudyGroupMember {
  id       String     @id @default(cuid())
  groupId  String
  userId   String
  role     String?    @default("member")
  joinedAt DateTime   @default(now())
  group    StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("study_group_member")
}

model KnowledgeResource {
  id         String        @id @default(cuid())
  title      String
  url        String?
  kind       String?       @default("general")
  content    String?
  metadata   Json?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  hubId      String?
  tenantId   String?
  superHubId String?
  caseId     String?
  tags       ResourceTag[]
  caseStudy  CaseStudy?    @relation("CaseStudyResources", fields: [caseId], references: [id])
  hub        Hub?          @relation(fields: [hubId], references: [id])
  superHub   SuperHub?     @relation(fields: [superHubId], references: [id])
  tenant     Tenant?       @relation(fields: [tenantId], references: [id])
  agents     AgentConfig[] @relation("AgentKnowledge")

  @@index([hubId])
  @@index([tenantId])
  @@index([superHubId])
  @@index([kind])
  @@map("knowledge_resource")
}

model ResourceTag {
  id         String            @id @default(cuid())
  resourceId String
  tagId      String
  resource   KnowledgeResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  tag        Tag               @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([resourceId, tagId])
  @@map("resource_tag")
}

model Tag {
  id        String        @id @default(cuid())
  name      String        @unique
  resources ResourceTag[]

  @@map("tag")
}

model Course {
  id            String        @id @default(cuid())
  tenantId      String?
  title         String
  subtitle      String?
  description   String?
  difficulty    String?
  durationHours Float?
  lang          String?       @default("es")
  status        String?       @default("draft")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  certificates  Certificate[]
  tenant        Tenant?       @relation(fields: [tenantId], references: [id])
  enrollments   Enrollment[]
  lessons       Lesson[]

  @@map("course")
}

model Lesson {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  subtitle    String?
  content     Json?
  durationMin Int?
  isQuiz      Boolean  @default(false)
  order       Int?     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz        Quiz?    @relation("LessonQuiz")

  @@map("lesson")
}

model Enrollment {
  id            String       @id @default(cuid())
  userId        String
  courseId      String
  progressPct   Float?       @default(0)
  status        String?      @default("active")
  score         Float?
  certificateId String?      @unique
  certificate   Certificate? @relation("EnrollmentCertificate", fields: [certificateId], references: [id])
  course        Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollment")
}

model Quiz {
  id           String        @id @default(cuid())
  title        String
  description  String?
  questions    Json
  passingScore Float?
  lessonId     String        @unique
  lesson       Lesson        @relation("LessonQuiz", fields: [lessonId], references: [id], onDelete: Cascade)
  attempts     QuizAttempt[]

  @@map("quiz")
}

model QuizAttempt {
  id        String   @id @default(cuid())
  quizId    String
  userId    String
  answers   Json
  score     Float?
  passed    Boolean? @default(false)
  createdAt DateTime @default(now())
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("quiz_attempt")
}

model Certificate {
  id           String      @id @default(cuid())
  courseId     String?
  userId       String
  projectId    String?
  issuedById   String?
  credentialId String?     @unique
  title        String
  description  String?
  emotionTag   String?
  issueDate    DateTime    @default(now())
  expiryDate   DateTime?
  verified     Boolean     @default(false)
  digitalUrl   String?
  signatureUrl String?
  meta         Json?
  createdAt    DateTime    @default(now())
  course       Course?     @relation(fields: [courseId], references: [id])
  issuedBy     User?       @relation("CertificateIssuedBy", fields: [issuedById], references: [id])
  project      Project?    @relation(fields: [projectId], references: [id])
  user         User        @relation("CertificateUser", fields: [userId], references: [id], onDelete: Cascade)
  enrollment   Enrollment? @relation("EnrollmentCertificate")

  @@map("certificate")
}

model AgentConfig {
  id                 String                @id @default(cuid())
  slug               String
  name               String
  description        String?
  avatar             String?
  type               String                @default("CUSTOM")
  model              String?
  prompt             String?
  tools              Json?
  tone               String?
  accessLevel        String?
  visibility         String?
  autoLearn          Boolean               @default(false)
  isActive           Boolean               @default(true)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  tenantId           String?
  superHubId         String?
  organizationId     String?
  hubId              String?
  systemId           String?

  // Personalizaci√≥n Cultural del Tenant/Org
  culturePrompt      String?               // Prompt adicional con cultura/valores de la empresa
  companyValues      String[]              @default([]) // Lista de valores corporativos
  companyMission     String?               // Misi√≥n de la empresa
  companyTone        String?               // Tono de comunicaci√≥n preferido
  industryContext    String?               // Contexto de la industria
  customInstructions String?               // Instrucciones personalizadas del admin
  brandVoice         Json?                 // Gu√≠a de voz de marca (formalidad, emojis, etc.)
  hub                Hub?                  @relation(fields: [hubId], references: [id])
  organization       Organization?         @relation(fields: [organizationId], references: [id])
  superHub           SuperHub?             @relation(fields: [superHubId], references: [id])
  system             System?               @relation(fields: [systemId], references: [id], onDelete: Cascade)
  tenant             Tenant?               @relation(fields: [tenantId], references: [id])
  contexts           AgentContext[]
  performanceReviews PerformanceReview[]
  knowledge          KnowledgeResource[]   @relation("AgentKnowledge")
  modelVersions      AgentModelVersion[]   @relation("AgentConfigToModelVersion")
  trainingSamples    AgentTrainingSample[] @relation("AgentConfigToTrainingSample")
  knowledgeDeployments AgentKnowledgeDeployment[]

  @@unique([slug, tenantId, superHubId, organizationId, hubId])
  @@index([slug])
  @@index([tenantId])
  @@index([superHubId])
  @@index([organizationId])
  @@index([hubId])
  @@index([slug, tenantId])
  @@map("agent_config")
}

model AgentContext {
  id            String      @id @default(cuid())
  agentId       String
  contextType   String
  contextId     String?
  isActive      Boolean     @default(true)
  autoLearn     Boolean     @default(false)
  learningData  Json?
  feedbackScore Float?
  customPrompt  String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  agent         AgentConfig @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, contextType, contextId])
  @@index([contextType])
  @@index([contextId])
  @@index([isActive])
  @@map("agent_context")
}

/// =========================================================
/// ‚öôÔ∏è USER AI CONTROL ‚Äî Control de acceso IA por usuario
/// =========================================================
/// Permite activar o desactivar agentes IA espec√≠ficos para cada usuario.
model UserAIControl {
  id        String   @id @default(cuid())
  userId    String
  feature   String
  enabled   Boolean  @default(true)
  updatedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, feature])
  @@index([userId])
  @@map("user_ai_control")
}

/// =========================================================
/// üìä USER USAGE ‚Äî Registro de uso y consumo IA
/// =========================================================
/// Guarda consumo de tokens y uso de IA por d√≠a, usuario y tenant.
model UserUsage {
  id           String   @id @default(cuid())
  userId       String
  tenantId     String?
  day          DateTime
  feature      String?
  tokensInput  Int      @default(0)
  tokensOutput Int      @default(0)
  createdAt    DateTime @default(now())
  tenant       Tenant?  @relation(fields: [tenantId], references: [id])
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, day, feature])
  @@index([tenantId])
  @@index([userId])
  @@map("user_usage")
}

model Page {
  id             String          @id @default(cuid())
  slug           String
  title          String
  summary        String?
  content        Json?
  components     Json?
  theme          Json?
  layoutConfig   Json?
  aiConfig       Json?
  seo            Json?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  canonicalURL   String?
  lang           String?         @default("es")
  published      Boolean         @default(false)
  systemId       String?
  tenantId       String?
  superHubId     String?
  organizationId String?
  authorId       String?
  visibility     String?         @default("global")
  accessLevel    String?         @default("public")
  rolesAllowed   String[]        @default([])
  scripts        Json?
  dataSources    Json?
  layoutId       String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  author         User?           @relation("PagesByAuthor", fields: [authorId], references: [id])
  layout         Layout?         @relation(fields: [layoutId], references: [id])
  organization   Organization?   @relation(fields: [organizationId], references: [id])
  superHub       SuperHub?       @relation(fields: [superHubId], references: [id])
  system         System?         @relation(fields: [systemId], references: [id], onDelete: Cascade)
  tenant         Tenant?         @relation(fields: [tenantId], references: [id])
  componentsR    PageComponent[]
  translations   Translation[]

  @@unique([slug, lang, tenantId, superHubId, organizationId])
  @@index([slug])
  @@index([tenantId])
  @@index([superHubId])
  @@index([organizationId])
  @@map("page")
}

model PageComponent {
  id          String    @id @default(cuid())
  pageId      String
  componentId String
  zone        String?
  position    Int?
  props       Json?
  dataBinding Json?
  style       Json?
  responsive  Json?
  aiConfig    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  component   Component @relation(fields: [componentId], references: [id])
  page        Page      @relation(fields: [pageId], references: [id])

  @@index([pageId])
  @@index([componentId])
  @@map("page_component")
}

/// üé® Cat√°logo global de layouts disponibles
model Layout {
  id             String            @id @default(cuid())
  name           String
  description    String?
  structure      Json?
  theme          Json?
  previewUrl     String?
  isDefault      Boolean           @default(false)
  systemId       String?
  tenantId       String?
  superHubId     String?
  organizationId String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organization   Organization?     @relation(fields: [organizationId], references: [id])
  superHub       SuperHub?         @relation(fields: [superHubId], references: [id])
  system         System?           @relation(fields: [systemId], references: [id], onDelete: Cascade)
  tenant         Tenant?           @relation(fields: [tenantId], references: [id])
  components     LayoutComponent[]
  pages          Page[]

  @@index([tenantId])
  @@index([superHubId])
  @@index([organizationId])
  @@map("layout")
}

model Component {
  id             String            @id @default(cuid())
  name           String
  type           String?
  category       String?
  description    String?
  icon           String?
  config         Json?
  schema         Json?
  style          Json?
  theme          Json?
  slots          Json?
  aiEnabled      Boolean           @default(false)
  aiConfig       Json?
  tenantId       String?
  superHubId     String?
  organizationId String?
  systemId       String?
  visibility     String?           @default("global")
  accessLevel    String?           @default("public")
  version        String?           @default("1.0.0")
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organization   Organization?     @relation(fields: [organizationId], references: [id])
  superHub       SuperHub?         @relation(fields: [superHubId], references: [id])
  system         System?           @relation(fields: [systemId], references: [id], onDelete: Cascade)
  tenant         Tenant?           @relation(fields: [tenantId], references: [id])
  usedInLayouts  LayoutComponent[]
  usedInPages    PageComponent[]

  @@index([tenantId])
  @@index([superHubId])
  @@index([organizationId])
  @@map("component")
}

model LayoutComponent {
  id          String    @id @default(cuid())
  layoutId    String
  componentId String
  zone        String?
  position    Int?
  props       Json?
  dataBinding Json?
  style       Json?
  responsive  Json?
  aiConfig    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  component   Component @relation(fields: [componentId], references: [id])
  layout      Layout    @relation(fields: [layoutId], references: [id])

  @@index([layoutId])
  @@index([componentId])
  @@map("layout_component")
}

/// *
/// * =========================================================
/// * üåê TRANSLATION ‚Äî Sistema de traducciones por Tenant/P√°gina
/// * =========================================================
/// * Permite almacenar pares clave/valor de traducciones
/// * asociadas a un tenant o p√°gina espec√≠fica.
/// * Soporta namespaces (ns) opcionales para organizaci√≥n modular.
model Translation {
  id        String   @id @default(cuid())
  tenantId  String?
  pageId    String?
  ns        String?  @default("common")
  key       String
  value     String
  lang      String?  @default("es")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  systemId  String?
  page      Page?    @relation(fields: [pageId], references: [id])
  system    System?  @relation(fields: [systemId], references: [id], onDelete: Cascade)
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, ns, key, lang])
  @@unique([systemId, ns, key, lang])
  @@index([tenantId, pageId])
  @@map("translation")
}

model ExternalConnection {
  id         String   @id @default(cuid())
  tenantId   String?
  type       String
  name       String
  connection Json
  createdAt  DateTime @default(now())
  tenant     Tenant?  @relation(fields: [tenantId], references: [id])

  @@map("external_connection")
}

model Webhook {
  id        String   @id @default(cuid())
  tenantId  String?
  targetUrl String
  secret    String?
  events    String[]
  createdAt DateTime @default(now())
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("webhook")
}

/// *
/// * =========================================================
/// * üßæ AUDIT LOG ‚Äî Registro de acciones del sistema
/// * =========================================================
/// * Guarda informaci√≥n de auditor√≠a sobre acciones ejecutadas
/// * por usuarios o agentes del sistema (creaci√≥n, edici√≥n, borrado, etc.)
model AuditLog {
  id        String   @id @default(cuid())
  actorId   String?
  targetId  String?
  action    String
  entity    String?
  meta      Json?
  createdAt DateTime @default(now())
  actor     User?    @relation("AuditActor", fields: [actorId], references: [id])
  target    User?    @relation("AuditTarget", fields: [targetId], references: [id])

  @@map("audit_log")
}

model AccountCategory {
  id           String              @id @default(cuid())
  projectId    String?
  code         String              @unique
  name         String
  type         AccountCategoryType
  description  String?
  parentId     String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  parent       AccountCategory?    @relation("AccountCategoryToAccountCategory", fields: [parentId], references: [id])
  children     AccountCategory[]   @relation("AccountCategoryToAccountCategory")
  project      Project?            @relation(fields: [projectId], references: [id])
  transactions Transaction[]

  @@map("account_category")
}

model Transaction {
  id          String           @id @default(cuid())
  tenantId    String?
  hubId       String?
  accountId   String?
  type        TransactionType
  description String?
  amountUsd   Decimal          @db.Decimal(12, 2)
  currency    String           @default("USD")
  date        DateTime         @default(now())
  reference   String?
  status      String           @default("recorded")
  method      String?
  meta        Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  projectId   String?
  allocations CostAllocation[]
  account     AccountCategory? @relation(fields: [accountId], references: [id])
  hub         Hub?             @relation(fields: [hubId], references: [id])
  Project     Project?         @relation(fields: [projectId], references: [id])
  tenant      Tenant?          @relation(fields: [tenantId], references: [id])

  @@index([tenantId, hubId, date])
  @@map("transaction")
}

model Invoice {
  id          String        @id @default(cuid())
  tenantId    String?
  hubId       String?
  number      String?
  type        String
  clientName  String
  clientEmail String?
  description String?
  totalUsd    Decimal       @db.Decimal(12, 2)
  taxUsd      Decimal?      @db.Decimal(12, 2)
  status      String        @default("draft")
  issueDate   DateTime      @default(now())
  dueDate     DateTime?
  meta        Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  hub         Hub?          @relation(fields: [hubId], references: [id])
  tenant      Tenant?       @relation(fields: [tenantId], references: [id])
  items       InvoiceItem[]

  @@index([tenantId, hubId, issueDate])
  @@map("invoice")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  productId   String?
  description String?
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(12, 2)
  totalUsd    Decimal  @db.Decimal(12, 2)
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])

  @@map("invoice_item")
}

model CostCenter {
  id          String           @id @default(cuid())
  tenantId    String
  code        String
  name        String
  description String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  allocations CostAllocation[]
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  links       CostCenterLink[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("cost_center")
}

model CostCenterLink {
  id           String     @id @default(cuid())
  costCenterId String
  hubId        String?
  weight       Float?     @default(1)
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id], onDelete: Cascade)
  hub          Hub?       @relation(fields: [hubId], references: [id])

  @@map("cost_center_link")
}

model CostAllocation {
  id            String       @id @default(cuid())
  costCenterId  String
  transactionId String?
  amountUsd     Decimal      @db.Decimal(12, 2)
  notes         String?
  createdAt     DateTime     @default(now())
  costCenter    CostCenter   @relation(fields: [costCenterId], references: [id], onDelete: Cascade)
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  @@index([costCenterId, transactionId])
  @@map("cost_allocation")
}

model Product {
  id            String              @id @default(cuid())
  tenantId      String?
  sku           String              @unique
  name          String
  description   String?
  category      String?
  unitCostUsd   Decimal             @db.Decimal(12, 2)
  priceUsd      Decimal             @db.Decimal(12, 2)
  stockQty      Int                 @default(0)
  reorderLevel  Int?                @default(5)
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  movements     InventoryMovement[]
  invoiceItems  InvoiceItem[]
  tenant        Tenant?             @relation(fields: [tenantId], references: [id])
  purchaseItems PurchaseOrderItem[]
  saleItems     SalesOrderItem[]

  @@map("product")
}

model InventoryMovement {
  id          String                @id @default(cuid())
  productId   String
  type        InventoryMovementType
  quantity    Int
  unitCostUsd Decimal               @db.Decimal(12, 2)
  totalUsd    Decimal               @db.Decimal(12, 2)
  reference   String?
  sourceType  String?
  date        DateTime              @default(now())
  meta        Json?
  product     Product               @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, date])
  @@map("inventory_movement")
}

model PurchaseOrder {
  id            String              @id @default(cuid())
  tenantId      String?
  supplierName  String
  supplierEmail String?
  status        String              @default("draft")
  totalUsd      Decimal             @db.Decimal(12, 2)
  issueDate     DateTime            @default(now())
  expectedDate  DateTime?
  reference     String?
  notes         String?
  meta          Json?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  tenant        Tenant?             @relation(fields: [tenantId], references: [id])
  items         PurchaseOrderItem[]

  @@index([tenantId, issueDate])
  @@map("purchase_order")
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  productId       String?
  description     String?
  quantity        Int           @default(1)
  unitCostUsd     Decimal       @db.Decimal(12, 2)
  totalUsd        Decimal       @db.Decimal(12, 2)
  product         Product?      @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("purchase_order_item")
}

model SalesOrder {
  id           String           @id @default(cuid())
  tenantId     String?
  clientName   String
  clientEmail  String?
  status       String           @default("draft")
  totalUsd     Decimal          @db.Decimal(12, 2)
  issueDate    DateTime         @default(now())
  deliveryDate DateTime?
  reference    String?
  notes        String?
  meta         Json?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  tenant       Tenant?          @relation(fields: [tenantId], references: [id])
  items        SalesOrderItem[]

  @@index([tenantId, issueDate])
  @@map("sales_order")
}

model SalesOrderItem {
  id           String     @id @default(cuid())
  salesOrderId String
  productId    String?
  description  String?
  quantity     Int        @default(1)
  unitPrice    Decimal    @db.Decimal(12, 2)
  totalUsd     Decimal    @db.Decimal(12, 2)
  product      Product?   @relation(fields: [productId], references: [id])
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  @@map("sales_order_item")
}

model Asset {
  id               String      @id @default(cuid())
  tenantId         String?
  name             String
  description      String?
  category         String?
  acquisitionDate  DateTime?
  valueUsd         Decimal     @db.Decimal(12, 2)
  depreciationRate Float?
  status           AssetStatus @default(ACTIVE)
  location         String?
  tags             String[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  projectId        String?
  Project          Project?    @relation(fields: [projectId], references: [id])
  tenant           Tenant?     @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("asset")
}

model PayrollRun {
  id          String        @id @default(cuid())
  tenantId    String
  period      PayrollPeriod @default(MONTHLY)
  periodStart DateTime
  periodEnd   DateTime
  status      String        @default("open")
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  items       PayrollItem[]
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, periodStart, periodEnd])
  @@map("payroll_run")
}

model PayrollItem {
  id           String          @id @default(cuid())
  payrollRunId String
  employeeId   String
  concept      String
  amountUsd    Decimal         @db.Decimal(12, 2)
  notes        String?
  createdAt    DateTime        @default(now())
  employee     EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  payrollRun   PayrollRun      @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  @@index([payrollRunId, employeeId])
  @@map("payroll_item")
}

model EmployeeProfile {
  id           String              @id @default(cuid())
  userId       String
  tenantId     String?
  position     String?
  department   String?
  hireDate     DateTime?
  salaryUsd    Decimal?            @db.Decimal(10, 2)
  contractType ContractType?
  status       EmploymentStatus    @default(ACTIVE)
  skills       String[]
  notes        String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  projectId    String?
  Project      Project?            @relation(fields: [projectId], references: [id])
  tenant       Tenant?             @relation(fields: [tenantId], references: [id])
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaves       LeaveRequest[]
  payrollItems PayrollItem[]
  reviews      PerformanceReview[]
  logs         ProductivityLog[]
  timeEntries  TimeEntry[]

  @@map("employee_profile")
}

model PerformanceReview {
  id             String          @id @default(cuid())
  employeeId     String
  reviewerId     String?
  agentId        String?
  periodStart    DateTime
  periodEnd      DateTime
  score          Float?
  emotionalScore Float?
  comments       String?
  goals          Json?
  insightsAI     Json?
  status         String?         @default("open")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  agent          AgentConfig?    @relation(fields: [agentId], references: [id])
  employee       EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  reviewer       User?           @relation("UserAsReviewer", fields: [reviewerId], references: [id])

  @@index([employeeId, reviewerId, agentId])
  @@map("performance_review")
}

/// *
/// * =========================================================
/// * ‚è±Ô∏è TIME ENTRY ‚Äî Registro de tiempo y actividad
/// * =========================================================
/// * Representa bloques de tiempo trabajados por un colaborador,
/// * permitiendo an√°lisis de productividad, facturaci√≥n y bienestar.
model TimeEntry {
  id          String          @id @default(cuid())
  employeeId  String
  startedAt   DateTime
  endedAt     DateTime?
  minutes     Int?
  activity    String?
  billable    Boolean         @default(false)
  rateUsdHour Decimal?        @db.Decimal(10, 2)
  emotionTag  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  employee    EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, startedAt])
  @@map("time_entry")
}

/// *
/// * =========================================================
/// * üìä PRODUCTIVITY LOG ‚Äî Registro de productividad y enfoque
/// * =========================================================
/// * Registra bloques de trabajo con su carga emocional,
/// * tiempo invertido, nivel de foco y rendimiento percibido.
/// * Permite correlacionar productividad con bienestar emocional.
model ProductivityLog {
  id                String          @id @default(cuid())
  employeeId        String
  taskName          String?
  hoursSpent        Float?          @default(0)
  focusLevel        Float?
  emotionTag        String?
  productivityIndex Float?
  date              DateTime        @default(now())
  notes             String?
  employee          EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, date])
  @@map("productivity_log")
}

model AnalyticsSnapshot {
  id          String   @id @default(cuid())
  tenantId    String?
  date        DateTime
  scope       String
  metricKey   String
  metricValue Float?
  meta        Json?
  createdAt   DateTime @default(now())
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([tenantId, date, scope, metricKey])
  @@map("analytics_snapshot")
}

model PredictiveMetric {
  id          String    @id @default(cuid())
  tenantId    String?
  projectId   String?
  hubId       String?
  superHubId  String?
  horizonDays Int       @default(30)
  scope       String
  metricKey   String
  value       Float?
  confidence  Float?
  generatedBy String?
  meta        Json?
  createdAt   DateTime  @default(now())
  hub         Hub?      @relation(fields: [hubId], references: [id])
  project     Project?  @relation(fields: [projectId], references: [id])
  superHub    SuperHub? @relation("SuperHubForecasts", fields: [superHubId], references: [id])
  tenant      Tenant?   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([projectId])
  @@index([hubId])
  @@index([superHubId])
  @@index([scope, metricKey])
  @@map("predictive_metric")
}

/// *
/// * =========================================================
/// * üå¥ LEAVE REQUEST ‚Äî Solicitudes de ausencia
/// * =========================================================
/// * Permite registrar vacaciones, licencias, ausencias por enfermedad o capacitaciones.
model LeaveRequest {
  id         String          @id @default(cuid())
  employeeId String
  type       String
  status     LeaveStatus     @default(PENDING)
  startDate  DateTime
  endDate    DateTime
  reason     String?
  approvedBy String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  approver   User?           @relation("LeaveApprover", fields: [approvedBy], references: [id])
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([approvedBy])
  @@map("leave_request")
}

model Payout {
  id          String    @id @default(cuid())
  userId      String?
  tenantId    String?
  projectId   String?
  amountUsd   Decimal   @db.Decimal(12, 2)
  description String?
  reference   String?
  status      String    @default("pending")
  method      String?
  issuedAt    DateTime  @default(now())
  paidAt      DateTime?
  meta        Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Project     Project?  @relation(fields: [projectId], references: [id])
  tenant      Tenant?   @relation(fields: [tenantId], references: [id])
  user        User?     @relation(fields: [userId], references: [id])

  @@map("payout")
}

model UsageDaily {
  id           String       @id @default(cuid())
  tenantId     String
  day          DateTime
  feature      UsageFeature
  model        String?
  tokensInput  Int          @default(0)
  tokensOutput Int          @default(0)
  calls        Int          @default(0)
  costUsd      Decimal?     @db.Decimal(10, 4)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, feature, day, model])
  @@index([tenantId, day])
  @@map("usage_daily")
}

model TenantModule {
  id          String   @id @default(cuid())
  tenantId    String
  key         String
  name        String?
  description String?
  enabled     Boolean  @default(true)
  visibility  String?
  config      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@map("tenant_module")
}

model Warehouse {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  code      String
  location  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@map("warehouse")
}

/// *
/// * =========================================================
/// * üìÅ PROJECT ‚Äî Entidad gen√©rica para conectar m√≥dulos
/// * =========================================================
/// * Representa proyectos, programas o iniciativas asociadas
/// * a un Tenant o Hub, vinculadas con m√©tricas, certificados
/// * y transacciones.
model Project {
  id                String             @id @default(cuid())
  tenantId          String?
  hubId             String?
  name              String
  description       String?
  status            String?            @default("active")
  startDate         DateTime?
  endDate           DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  accountCategories AccountCategory[]
  assets            Asset[]
  certificates      Certificate[]
  employees         EmployeeProfile[]
  payouts           Payout[]
  predictiveMetrics PredictiveMetric[]
  hub               Hub?               @relation(fields: [hubId], references: [id])
  tenant            Tenant?            @relation(fields: [tenantId], references: [id])
  transactions      Transaction[]

  @@index([tenantId])
  @@index([hubId])
  @@map("project")
}

/// *
/// * =========================================================
/// * üß† EMOTIONAL AI ENGINE ‚Äî Configuraci√≥n del motor emocional de IA
/// * =========================================================
/// * Define el estado y par√°metros de un motor IA por Tenant o Hub.
/// * Se usa en /api/ai/engine y por los agentes (eco, eq, trainer, etc.)
model EmotionalAIEngine {
  id          String   @id @default(cuid())
  tenantId    String?
  hubId       String?
  state       String   @default("idle")
  mode        String   @default("coach")
  description String?  @default("Motor emocional activo")
  temperature Float    @default(0.7)
  contextSize Int      @default(8192)
  memorySpan  Int      @default(30)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  hub         Hub?     @relation(fields: [hubId], references: [id])
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, hubId])
  @@index([tenantId])
  @@index([hubId])
  @@map("emotional_ai_engine")
}

/// =========================================================
/// üíû AFFINITY SNAPSHOT ‚Äî Afinidad emocional global
/// =========================================================
model AffinitySnapshot {
  id             String   @id @default(cuid())
  userId         String
  memberId       String
  userGlobalId   String? // üîó RowiVerseUser del usuario local
  memberGlobalId String? // üîó RowiVerseUser del miembro
  context        String
  lastHeat135    Int?
  aiSummary      String?
  biasFactor     Float?
  closeness      String?
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  member       CommunityMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userGlobal   RowiVerseUser?  @relation("AffinityUserGlobal", fields: [userGlobalId], references: [id])
  memberGlobal RowiVerseUser?  @relation("AffinityMemberGlobal", fields: [memberGlobalId], references: [id])

  @@unique([userId, memberId, context])
  @@index([userId])
  @@index([memberId])
  @@index([userGlobalId])
  @@index([memberGlobalId])
  @@map("affinity_snapshot")
}

/// =========================================================
/// üí¨ AFFINITY INTERACTION ‚Äî Micro-interacciones y emociones
/// =========================================================
model AffinityInteraction {
  id             String   @id @default(cuid())
  userId         String
  memberId       String
  userGlobalId   String? // üîó RowiVerseUser del usuario local
  memberGlobalId String? // üîó RowiVerseUser del miembro
  context        String?
  emotionTag     String?
  effectiveness  Float?
  notes          String?
  createdAt      DateTime @default(now())

  member       CommunityMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userGlobal   RowiVerseUser?  @relation("InteractionUserGlobal", fields: [userGlobalId], references: [id])
  memberGlobal RowiVerseUser?  @relation("InteractionMemberGlobal", fields: [memberGlobalId], references: [id])

  @@index([userId])
  @@index([memberId])
  @@index([userGlobalId])
  @@index([memberGlobalId])
  @@map("affinity_interaction")
}

model AffinityProfile {
  id       String @id @default(cuid())
  userId   String @unique
  traits   Json   @default("{}")
  clusters Json   @default("{}")
  scores   Json   @default("{}")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("affinity_profile")
}

/// =========================================================
/// üß† INSIGHT RECORD ‚Äî Resultados de IA Cognitiva Manual
/// =========================================================
model InsightRecord {
  id          String    @id @default(cuid())
  type        String
  title       String
  content     String
  generatedBy String?
  sourceModel String?
  createdAt   DateTime  @default(now())
  hubId       String?
  tenantId    String?
  superHubId  String?
  meta        Json?
  hub         Hub?      @relation(fields: [hubId], references: [id])
  superHub    SuperHub? @relation(fields: [superHubId], references: [id])
  tenant      Tenant?   @relation(fields: [tenantId], references: [id])

  @@index([hubId])
  @@index([tenantId])
  @@index([superHubId])
  @@map("insight_record")
}

/// =========================================================
/// csv UPLAOD NUEVO 
/// =========================================================
model CsvUpload {
  id        String   @id @default(cuid())
  userEmail String
  dataset   String?
  rowCount  Int?
  createdAt DateTime @default(now())
  user      User     @relation("UserCsvUploads", fields: [userEmail], references: [email])

  @@map("csv_upload")
}

/// =========================================================
/// üíå INVITE TOKEN ‚Äî Invitaciones pendientes
/// =========================================================
model InviteToken {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String?
  email     String
  role      String?  @default("USER")
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  tenant    Tenant?  @relation("TenantInvites", fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation("UserInvites", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([email])
  @@map("invite_token")
}

/// =========================================================
/// üßæ ACTIVITY LOG ‚Äî Registro de acciones administrativas
/// =========================================================
model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String?
  targetId  String?
  details   Json?
  createdAt DateTime @default(now())
  user      User     @relation("UserActivityLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@map("activity_log")
}

model RoleDynamic {
  id          String    @id @default(cuid())
  name        String
  description String?
  level       RoleLevel @default(HUB)
  hubId       String?
  tenantId    String?
  superHubId  String?
  planId      String?
  permissions Json?
  color       String?
  icon        String?
  createdAt   DateTime  @default(now())
  hub         Hub?      @relation(fields: [hubId], references: [id])
  plan        Plan?     @relation(fields: [planId], references: [id])
  superHub    SuperHub? @relation(fields: [superHubId], references: [id])
  tenant      Tenant?   @relation(fields: [tenantId], references: [id])

  @@unique([name, tenantId])
  @@unique([name, superHubId])
  @@index([hubId])
  @@index([tenantId])
  @@index([superHubId])
  @@index([planId])
  @@map("role_dynamic")
}

/// =========================================================
/// üì¶ IMPORT BATCH ‚Äî Carga masiva asistida de usuarios
/// =========================================================
model ImportBatch {
  id         String      @id @default(cuid())
  name       String
  uploadedBy String
  uploadedAt DateTime    @default(now())
  totalRows  Int
  processed  Boolean     @default(false)
  rows       ImportRow[]

  @@map("import_batch")
}

model ImportRow {
  id       String      @id @default(cuid())
  batchId  String
  email    String?
  name     String?
  surname  String?
  country  String?
  jobRole  String?
  sector   String?
  data     Json
  selected Boolean     @default(true)
  status   String      @default("pending")
  message  String?
  batch    ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@map("import_row")
}

/// =========================================================
/// ‚öôÔ∏è BACKGROUND TASK ‚Äî Tareas as√≠ncronas de IA o sistema
/// =========================================================
/// Guarda trabajos en segundo plano (entrenamientos, c√°lculos, sincronizaciones).
model BackgroundTask {
  id          String    @id @default(cuid())
  type        String
  status      String    @default("pending") // pending | running | completed | failed
  description String?
  payload     Json? // Datos de entrada o contexto del job
  result      Json? // Resultado o salida final del proceso
  error       String? // Mensaje de error (si aplica)
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("background_task")
}

/// =========================================================
/// ü§ñ AGENT MODEL VERSION ‚Äî Versionado de modelos IA
/// =========================================================
/// Controla las versiones de los modelos IA usados por los agentes.
model AgentModelVersion {
  id          String      @id @default(cuid())
  agentId     String
  version     Int         @default(1)
  modelName   String
  description String?
  metrics     Json? // Precisi√≥n, costo, performance
  createdAt   DateTime    @default(now())
  agent       AgentConfig @relation("AgentConfigToModelVersion", fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, version])
  @@index([modelName])
  @@map("agent_model_version")
}

/// =========================================================
/// üß† AGENT TRAINING SAMPLE ‚Äî Dataset de entrenamiento IA
/// =========================================================
/// Guarda ejemplos usados para entrenar o ajustar modelos IA.
model AgentTrainingSample {
  id        String      @id @default(cuid())
  agentId   String
  input     String // Prompt o entrada de entrenamiento
  output    String // Respuesta esperada
  meta      Json? // Datos adicionales o tags
  createdAt DateTime    @default(now())
  agent     AgentConfig @relation("AgentConfigToTrainingSample", fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@map("agent_training_sample")
}

/// =========================================================
/// üí´ EMOTIONAL CONFIG ‚Äî Configuraci√≥n emocional base
/// =========================================================
/// Define par√°metros emocionales por Tenant, como intensidad,
/// escalas de humor o l√≠mites de an√°lisis emocional.
model EmotionalConfig {
  id          String   @id @default(cuid())
  tenantId    String?
  key         String
  value       Json?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant?  @relation("TenantToEmotionalConfig", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("emotional_config")
}

model RowiVerse {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  bannerUrl   String?
  visibility  String   @default("public")
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // üîπ Relaci√≥n con el creador
  createdBy User? @relation("UserCreatedVerses", fields: [createdById], references: [id])

  // üîπ SuperHubs, Tenants y Organizaciones vinculadas (inversas)
  superHubs      SuperHub[]      @relation("RowiVerseToSuperHub")
  tenants        Tenant[]        @relation("RowiVerseToTenant")
  organizations  Organization[]  @relation("RowiVerseToOrganization")
  communitiesSet RowiCommunity[] @relation("RowiVerseToCommunity")

  // üîπ Usuarios globales vinculados al RowiVerse
  users RowiVerseUser[] @relation("RowiVerseToUser")

  @@map("rowi_verse")
}

/// üåç RowiVerseUser ‚Äî Identidad universal dentro del RowiVerse
/// ---------------------------------------------------------
/// Representa la identidad global de una persona dentro del ecosistema.
/// Est√° vinculada a un `User` local y al `RowiVerse` global.
model RowiVerseUser {
  id        String   @id @default(cuid())
  email     String?  @unique
  name      String?
  image     String?
  verified  Boolean  @default(false)
  active    Boolean  @default(true)
  country   String?  @default("NONE")
  language  String?  @default("es")
  status    String?  @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Relaciones principales
  userId      String? @unique
  rowiVerseId String?

  // ‚úÖ Relaci√≥n principal con el usuario local
  user User? @relation("UserRowiVerseLink", fields: [userId], references: [id])

  // ‚úÖ Relaci√≥n con el ecosistema global (RowiVerse)
  rowiVerse RowiVerse? @relation("RowiVerseToUser", fields: [rowiVerseId], references: [id], onDelete: Cascade)

  // üîÑ Relaciones inversas con m√≥dulos del ecosistema
  communityMembers             CommunityMember[]
  eqSnapshots                  EqSnapshot[]
  emotionalEvents              EmotionalEvent[]
  initiatorRelations           RowiRelation[]        @relation("GlobalInitiatorRelation")
  receiverRelations            RowiRelation[]        @relation("GlobalReceiverRelation")
  affinitySnapshotsAsUser      AffinitySnapshot[]    @relation("AffinityUserGlobal")
  affinitySnapshotsAsMember    AffinitySnapshot[]    @relation("AffinityMemberGlobal")
  affinityInteractionsAsUser   AffinityInteraction[] @relation("InteractionUserGlobal")
  affinityInteractionsAsMember AffinityInteraction[] @relation("InteractionMemberGlobal")
  RowiCommunityUser            RowiCommunityUser[]

  @@unique([userId, rowiVerseId])
  @@index([country])
  @@index([language])
  @@index([status])
  @@map("rowiverse_user")
}

/// üåê Comunidad dentro del ecosistema RowiVerse
/// ---------------------------------------------------------
/// Ejemplo: ‚ÄúEQ Week Costa Rica‚Äù, ‚Äú6S Staff Retreat‚Äù, ‚ÄúCactus Academy‚Äù
/// üåê Comunidad dentro del ecosistema RowiVerse
model RowiCommunity {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  description    String?
  type           String?  @default("general")
  visibility     String   @default("public")
  bannerUrl      String?
  coverUrl       String?
  category       String?
  rules          String?
  createdById    String?
  superId        String?
  rowiVerseId    String?
  superHubId     String?
  hubId          String?
  tenantId       String?
  organizationId String?
  teamType       String?  // biz, impact, coaching, education, research, ops, tech, marketing
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // üë§ Datos administrativos
  owner         String? // Nombre o referencia textual del creador
  language      String?
  executionTime Int?

  // üîó Relaciones jer√°rquicas (todas con nombres expl√≠citos)
  rowiVerse    RowiVerse?    @relation("RowiVerseToCommunity", fields: [rowiVerseId], references: [id], map: "fk_rowiCommunity_rowiVerseId", onDelete: Cascade)
  superHub     SuperHub?     @relation("SuperHubToCommunity", fields: [superHubId], references: [id], map: "fk_rowiCommunity_superHubId", onDelete: Cascade)
  hub          Hub?          @relation("HubToCommunity", fields: [hubId], references: [id], map: "fk_rowiCommunity_hubId", onDelete: Cascade)
  tenant       Tenant?       @relation("TenantToCommunity", fields: [tenantId], references: [id], map: "fk_rowiCommunity_tenantId", onDelete: Cascade)
  organization Organization? @relation("OrganizationToCommunity", fields: [organizationId], references: [id], map: "fk_rowiCommunity_organizationId", onDelete: Cascade)
  createdBy    User?         @relation(fields: [createdById], references: [id])

  // üîÅ Jerarqu√≠a de subcomunidades
  superCommunity RowiCommunity?  @relation("RowiCommunityHierarchy", fields: [superId], references: [id])
  subCommunities RowiCommunity[] @relation("RowiCommunityHierarchy")

  // üë• Relaciones internas
  members        RowiCommunityUser[]
  posts          RowiCommunityPost[]
  CommunityBatch CommunityBatch[]

  // üß≠ √çndices
  @@index([rowiVerseId])
  @@index([superHubId])
  @@index([hubId])
  @@index([tenantId])
  @@index([organizationId])
  @@map("rowi_community")
}

/// üë• Relaci√≥n usuario ‚Üî comunidad social
model RowiCommunityUser {
  id              String  @id @default(cuid())
  userId          String? // üîÑ opcional hasta que se vincule
  rowiverseUserId String? // üîó Identidad global RowiVerse
  communityId     String

  // üë§ Datos del miembro (copiados para b√∫squeda r√°pida)
  name           String?               // Nombre del miembro
  email          String?               // Email del miembro
  phone          String?               // Tel√©fono del miembro
  language       String?   @default("es")

  role           String?   @default("member") // owner | admin | coach | mentor | member | friend | client
  relationToMe   String? // c√≥mo percibo a esta persona: "mi coach", "mi amigo", "mi pareja", etc.
  connectionType String? // tipo de v√≠nculo: "profesional", "emocional", "familiar", "social"
  affinityLevel  Int? // nivel emocional (0‚Äì135 o escala interna)
  trustLevel     Int? // confianza o apertura emocional
  status         String?   @default("active") // active | invited | pending | blocked
  invitedById    String?
  joinedAt       DateTime  @default(now())
  lastActiveAt   DateTime?

  // Relaciones existentes
  user      User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  community RowiCommunity @relation(fields: [communityId], references: [id], onDelete: Cascade)
  invitedBy User?         @relation("RowiCommunityInviter", fields: [invitedById], references: [id])

  // Nueva relaci√≥n global
  rowiverseUser RowiVerseUser? @relation(fields: [rowiverseUserId], references: [id])

  @@unique([userId, communityId])
  @@index([communityId])
  @@index([userId])
  @@map("rowi_community_user")
}

/// üí¨ Publicaciones dentro de una comunidad
model RowiCommunityPost {
  id          String        @id @default(cuid())
  communityId String
  authorId    String
  content     String
  mediaUrl    String?
  tags        String[]
  emotionTag  String?
  visibility  String?       @default("community")
  reactions   Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  community   RowiCommunity @relation(fields: [communityId], references: [id], onDelete: Cascade)
  author      User          @relation(fields: [authorId], references: [id])

  @@map("rowi_community_post")
}

model CommunityBatch {
  id          String        @id @default(cuid())
  communityId String
  fileName    String
  totalRows   Int
  processed   Boolean       @default(false)
  createdAt   DateTime      @default(now())
  data        Json?
  community   RowiCommunity @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@map("community_batch")
}

/// üîó EcosystemLink ‚Äî Relaci√≥n jer√°rquica flexible entre entidades principales
model EcosystemLink {
  id          String   @id @default(cuid())
  type        String // Ej: "organization‚Üîtenant", "hub‚Üîorganization", "superhub‚Üîtenant"
  sourceType  String // Ej: "organization", "hub", "tenant"
  sourceId    String
  targetType  String // Ej: "hub", "tenant", "superhub"
  targetId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  metadata    Json?

  createdBy User? @relation(fields: [createdById], references: [id])

  // üîé √≠ndices para b√∫squedas r√°pidas
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@index([type])
  @@map("ecosystem_link")
}

/// *
/// * =========================================================
/// * üß© TENANT ROLE ‚Äî Roles dentro de una organizaci√≥n
/// * =========================================================
/// * Define los permisos y responsabilidades de cada usuario
/// * dentro de un Tenant (empresa, centro o comunidad).
enum TenantRole {
  SUPERADMIN
  ADMIN
  MANAGER
  EDITOR
  VIEWER
  DEVELOPER
  BILLING
  FEDERATOR
}

/// üöÄ Estado del usuario en el proceso de onboarding
enum OnboardingStatus {
  REGISTERED        // Cuenta creada
  PAYMENT_PENDING   // Esperando pago (plan pago)
  ONBOARDING        // Completando datos b√°sicos
  PENDING_SEI       // Esperando resultados del SEI
  ACTIVE            // Usuario completamente activo
  SUSPENDED         // Cuenta suspendida
  TRIAL_EXPIRED     // Trial expir√≥ sin suscripci√≥n
  CANCELLED         // Usuario cancel√≥ suscripci√≥n
}

enum OrgRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

/// üè¢ Tipo de unidad organizacional en jerarqu√≠a
/// ------------------------------------------------
/// WORLD = Six Seconds (ra√≠z global)
/// REGION = LATAM, EMEA, APAC, etc.
/// COUNTRY = Per√∫, M√©xico, USA, etc.
/// DIVISION = Staff, Coaches, etc.
/// TEAM = Equipo espec√≠fico
/// CLIENT = Cliente final
enum OrgUnitType {
  WORLD
  REGION
  COUNTRY
  DIVISION
  TEAM
  COMMUNITY
  CLIENT
}

enum AgentType {
  AFFINITY
  ECO
  EQ
  SALES
  TRAINER
  SUPER
  CUSTOM
}

enum UsageFeature {
  AFFINITY
  ECO
  EQ
  SALES
  TRAINER
  SUPER
  ROWI_COACH
  ROWI_CHAT
  TTS
  STT
  IMPORT
  EXPORT
  CUSTOM_FEATURE
}

enum PayrollPeriod {
  MONTHLY
  BIWEEKLY
  WEEKLY
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum InvoiceType {
  SALE
  PURCHASE
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  SABBATICAL
  TERMINATED
}

enum ContractType {
  FULL_TIME
  PART_TIME
  FREELANCE
  CONTRACTOR
}

enum InventoryMovementType {
  IN
  OUT
  ADJUST
}

enum AssetStatus {
  ACTIVE
  DISPOSED
  MAINTENANCE
  DEPRECATED
}

/// *
/// * =========================================================
/// * üß≠ ENUM ‚Äî Estado del miembro de comunidad
/// * =========================================================
enum CommunityMemberStatus {
  ACTIVE
  INACTIVE
  INVITED
  SUSPENDED
  DELETED
}

enum AccountCategoryType {
  INCOME
  EXPENSE
  ASSET
  LIABILITY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RoleLevel {
  SYSTEM
  SUPERHUB
  HUB
  TENANT
  PLAN
}

enum PermissionScope {
  rowiverse
  superhub
  hub
  tenant
  organization
  community
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ü¶â ROWI 100% - NUEVOS MODELOS PARA FUNCIONALIDAD COMPLETA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/// =========================================================
/// ü•ö AVATAR EVOLUTION ‚Äî Evoluci√≥n gamificada del Rowi Personal
/// =========================================================
/// Cada usuario tiene su propio Rowi que evoluciona con su desarrollo
/// emocional. Desde Huevo ‚Üí Beb√© ‚Üí Joven ‚Üí Adulto ‚Üí Sabio.
model AvatarEvolution {
  id            String            @id @default(cuid())
  userId        String            @unique
  stage         AvatarStage       @default(EGG)
  experience    Int               @default(0)
  accessories   Json              @default("[]")
  colors        Json              @default("{}")
  hatched       Boolean           @default(false)
  hatchProgress Int               @default(0)
  brainStyle    String?
  personality   Json?
  unlockedAt    DateTime          @default(now())
  lastEvolution DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Sistema Dual de Niveles
  sixSecondsLevel Int             @default(1)       // 1-5, calculado de EqSnapshot overall4
  lastSeiSync     DateTime?                         // Ultima sincronizacion con SEI
  evolutionScore  Float           @default(0)       // Score combinado: (rowiLevel * 0.6) + (sixSecondsLevel * 0.4)
  daysActive      Int             @default(0)       // Dias desde registro (para hatch progress)

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  milestones AvatarMilestone[]

  @@index([stage])
  @@index([sixSecondsLevel])
  @@map("avatar_evolution")
}

/// =========================================================
/// üèÜ AVATAR MILESTONE ‚Äî Logros y hitos desbloqueados
/// =========================================================
model AvatarMilestone {
  id          String        @id @default(cuid())
  avatarId    String
  type        MilestoneType
  title       String?
  description String?
  xpReward    Int           @default(10)
  icon        String?
  rarity      String?       @default("common")
  metadata    Json?
  achievedAt  DateTime      @default(now())

  avatar AvatarEvolution @relation(fields: [avatarId], references: [id], onDelete: Cascade)

  @@index([avatarId])
  @@index([type])
  @@map("avatar_milestone")
}

/// =========================================================
/// üìä TOP PERFORMER METRIC ‚Äî Rankings de desempe√±o emocional
/// =========================================================
model TopPerformerMetric {
  id               String   @id @default(cuid())
  tenantId         String
  userId           String
  period           String
  periodType       String   @default("monthly")

  consistencyScore Float    @default(0)
  growthScore      Float    @default(0)
  impactScore      Float    @default(0)
  engagementScore  Float    @default(0)
  collaborationScore Float  @default(0)

  overallScore     Float    @default(0)
  overallRank      Int?
  previousRank     Int?
  rankChange       Int?

  breakdown        Json?
  calculatedAt     DateTime @default(now())
  createdAt        DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, period])
  @@index([tenantId, period])
  @@index([overallRank])
  @@map("top_performer_metric")
}

/// =========================================================
/// üß† COLLECTIVE PATTERN ‚Äî Patrones detectados en grupos
/// =========================================================
model CollectivePattern {
  id          String   @id @default(cuid())
  tenantId    String
  hubId       String?
  patternType String
  title       String
  description String?
  severity    String?  @default("info")
  data        Json
  confidence  Float    @default(0.5)
  affectedUsers Int    @default(0)
  recommendations Json?
  status      String   @default("active")
  detectedAt  DateTime @default(now())
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  hub    Hub?   @relation(fields: [hubId], references: [id])

  @@index([tenantId, patternType])
  @@index([hubId])
  @@index([status])
  @@map("collective_pattern")
}

/// =========================================================
/// üí∞ EMOTIONAL ROI ‚Äî Retorno de inversi√≥n emocional
/// =========================================================
model EmotionalROI {
  id              String   @id @default(cuid())
  tenantId        String
  userId          String?
  hubId           String?
  period          String
  periodType      String   @default("monthly")

  timeInvestedMinutes Int     @default(0)
  sessionsCount       Int     @default(0)
  reflectionsCount    Int     @default(0)
  practicesCompleted  Int     @default(0)

  eqImprovement       Float?
  affinityImprovement Float?
  productivityGain    Float?
  wellbeingScore      Float?
  decisionsTracked    Int     @default(0)
  positiveOutcomes    Int     @default(0)

  roiScore            Float?
  roiTrend            String?
  benchmark           Float?

  calculatedAt        DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])
  hub    Hub?   @relation(fields: [hubId], references: [id])

  @@unique([tenantId, userId, period])
  @@index([tenantId, period])
  @@index([userId])
  @@map("emotional_roi")
}

/// =========================================================
/// üéØ DECISION TRACKING ‚Äî Seguimiento de decisiones
/// =========================================================
model DecisionTracking {
  id            String   @id @default(cuid())
  userId        String
  tenantId      String?
  title         String
  description   String?
  category      String?
  context       String?
  emotionBefore String?
  emotionAfter  String?
  eqInfluence   Json?
  affinityImpact Json?

  outcome       String?  @default("pending")
  outcomeNotes  String?
  lessonsLearned String?
  followUpDate  DateTime?

  aiAnalysis    Json?
  aiScore       Float?

  decidedAt     DateTime @default(now())
  reviewedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([outcome])
  @@index([decidedAt])
  @@map("decision_tracking")
}

/// =========================================================
/// üîå INTEGRATION CONNECTION ‚Äî Conexiones con servicios externos
/// =========================================================
model IntegrationConnection {
  id            String   @id @default(cuid())
  tenantId      String
  userId        String?
  platform      IntegrationPlatform
  name          String
  status        String   @default("pending")

  accessToken   String?
  refreshToken  String?
  tokenExpiry   DateTime?
  scope         String?
  webhookUrl    String?
  webhookSecret String?

  config        Json?
  channelId     String?
  channelName   String?

  lastSyncAt    DateTime?
  messagesSent  Int      @default(0)
  errorsCount   Int      @default(0)
  lastError     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])

  @@unique([tenantId, platform, userId])
  @@index([tenantId])
  @@index([platform])
  @@index([status])
  @@map("integration_connection")
}

/// =========================================================
/// üé® TENANT BRANDING ‚Äî Theming corporativo por tenant
/// =========================================================
model TenantBranding {
  id              String   @id @default(cuid())
  tenantId        String   @unique

  primaryColor    String   @default("#31a2e3")
  secondaryColor  String   @default("#f378a5")
  accentColor     String?
  backgroundColor String?
  textColor       String?

  colorK          String   @default("#1E88E5")
  colorC          String   @default("#7A59C9")
  colorG          String   @default("#43A047")

  logoUrl         String?
  logoLightUrl    String?
  faviconUrl      String?
  backgroundImage String?

  fontHeading     String?  @default("Varela Round")
  fontBody        String?  @default("Poppins")

  defaultTheme    String   @default("light")

  customCss       String?
  cssVariables    Json?

  isActive        Boolean  @default(true)
  previewMode     Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_branding")
}

/// =========================================================
/// üìÖ CALENDAR EVENT ‚Äî Eventos de calendario sincronizados
/// =========================================================
model CalendarEvent {
  id            String   @id @default(cuid())
  userId        String
  integrationId String
  externalId    String
  title         String
  description   String?
  startTime     DateTime
  endTime       DateTime?
  location      String?
  attendees     Json?
  isAllDay      Boolean  @default(false)
  eventType     String?

  emotionalPrep Json?
  prepSentAt    DateTime?
  moodBefore    String?
  moodAfter     String?

  lastSyncAt    DateTime @default(now())
  syncStatus    String   @default("synced")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, externalId])
  @@index([userId, startTime])
  @@index([integrationId])
  @@map("calendar_event")
}

/// =========================================================
/// üí¨ NOTIFICATION QUEUE ‚Äî Cola de notificaciones/mensajes
/// =========================================================
model NotificationQueue {
  id            String   @id @default(cuid())
  userId        String
  tenantId      String?
  channel       String
  type          String
  title         String?
  message       String
  metadata      Json?
  priority      Int      @default(5)
  scheduledFor  DateTime?
  sentAt        DateTime?
  status        String   @default("pending")
  attempts      Int      @default(0)
  lastError     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId, status])
  @@index([scheduledFor])
  @@index([channel])
  @@map("notification_queue")
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ü¶â ENUMS NUEVOS PARA ROWI 100%
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

enum AvatarStage {
  EGG
  HATCHING
  BABY
  YOUNG
  ADULT
  WISE
}

enum MilestoneType {
  PROFILE_COMPLETE
  SEI_COMPLETE
  FIRST_COACH_SESSION
  SEVEN_DAY_STREAK
  THIRTY_DAY_STREAK
  AFFINITY_ANALYSIS
  COMMUNITY_JOIN
  FIRST_REFLECTION
  FIRST_DECISION
  EQ_IMPROVEMENT
  TOP_PERFORMER
  MENTOR
  INTEGRATIONS_SETUP
  CUSTOM

  // Evolucion del Avatar
  EGG_RECEIVED           // Recibio su huevito
  HATCHING_STARTED       // El huevo comenzo a eclosionar
  AVATAR_HATCHED         // El avatar eclosiono
  AVATAR_BABY            // Llego a BABY
  AVATAR_YOUNG           // Llego a YOUNG
  AVATAR_ADULT           // Llego a ADULT
  AVATAR_WISE            // Llego a WISE (maximo)

  // Six Seconds
  SEI_FIRST_ASSESSMENT   // Completo primer SEI
  SEI_LEVEL_UP           // Subio de nivel Six Seconds
}

enum IntegrationPlatform {
  SLACK
  TEAMS
  WHATSAPP
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR
  ZOOM
  EMAIL
  CUSTOM
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìä BENCHMARK ‚Äî Motor de Inteligencia Comparativa Viva
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/// Benchmark principal que contiene toda la data agregada para comparaciones
model Benchmark {
  id             String          @id @default(cuid())
  name           String
  description    String?
  type           BenchmarkType
  status         BenchmarkStatus @default(PROCESSING)

  // √Åmbito jer√°rquico (multinivel)
  scope          BenchmarkScope  @default(GLOBAL)
  tenantId       String?
  hubId          String?
  organizationId String?
  communityId    String?
  teamId         String?

  // Metadata
  sourceFile     String?
  totalRows      Int             @default(0)
  processedRows  Int             @default(0)
  dateRangeStart DateTime?
  dateRangeEnd   DateTime?

  uploadedBy     String
  uploadedAt     DateTime        @default(now())
  processedAt    DateTime?
  lastEnrichedAt DateTime?       // √öltima vez que se enriqueci√≥ con nueva data

  version        Int             @default(1)
  isActive       Boolean         @default(true)
  isLearning     Boolean         @default(true)  // Sigue aprendiendo de nueva data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant       Tenant?       @relation("TenantToBenchmark", fields: [tenantId], references: [id])
  hub          Hub?          @relation("HubToBenchmark", fields: [hubId], references: [id])
  organization Organization? @relation("OrganizationToBenchmark", fields: [organizationId], references: [id])

  dataPoints       BenchmarkDataPoint[]
  statistics       BenchmarkStatistic[]
  correlations     BenchmarkCorrelation[]
  topPerformers    BenchmarkTopPerformer[]
  outcomePatterns  BenchmarkOutcomePattern[]
  userComparisons  BenchmarkUserComparison[]

  @@index([type, scope, isActive])
  @@index([tenantId])
  @@index([hubId])
  @@map("benchmark")
}

enum BenchmarkType {
  ROWIVERSE      // Data global SOH
  EXTERNAL       // Benchmarks de mercado/industria
  INTERNAL       // Benchmarks organizacionales
}

enum BenchmarkScope {
  GLOBAL         // Todo el ecosistema
  REGION         // Por regi√≥n geogr√°fica
  COUNTRY        // Por pa√≠s
  SECTOR         // Por industria
  TENANT         // Por organizaci√≥n
  HUB            // Por hub/divisi√≥n
  TEAM           // Por equipo
  COMMUNITY      // Por comunidad
  COHORT         // Por cohorte (edad, rol, etc.)
}

enum BenchmarkStatus {
  PROCESSING
  COMPLETED
  ENRICHING      // Incorporando nueva data
  FAILED
  ARCHIVED
}

/// Data point individual del benchmark (cada registro de la fuente)
model BenchmarkDataPoint {
  id          String   @id @default(cuid())
  benchmarkId String

  // Origen (para learning feedback loop)
  sourceType  String?  // "soh", "rowiverse_user", "tenant_user"
  sourceId    String?  // ID del registro original
  sourceDate  DateTime?

  // Segmentaci√≥n demogr√°fica
  country     String?
  region      String?
  jobFunction String?
  jobRole     String?
  sector      String?
  ageRange    String?
  gender      String?
  education   String?
  generation  String?  // Millennials, Gen Z, etc.
  year        Int?     // A√±o del assessment (extra√≠do de Date/Year)
  month       Int?     // Mes del assessment (1-12, extra√≠do de Date)
  quarter     Int?     // Trimestre (1-4, calculado desde month)

  // Segmentaci√≥n organizacional
  tenantId    String?
  hubId       String?
  teamId      String?
  communityId String?

  // Core EQ (Know/Choose/Give)
  K           Float?
  C           Float?
  G           Float?
  eqTotal     Float?

  // 8 Competencias Six Seconds
  EL          Float?   // Emotional Literacy
  RP          Float?   // Recognize Patterns
  ACT         Float?   // Consequential Thinking
  NE          Float?   // Navigate Emotions
  IM          Float?   // Intrinsic Motivation
  OP          Float?   // Exercise Optimism
  EMP         Float?   // Empathy
  NG          Float?   // Noble Goals

  // Outcomes (lo que buscamos predecir)
  effectiveness    Float?
  relationships    Float?
  qualityOfLife    Float?
  wellbeing        Float?
  influence        Float?
  decisionMaking   Float?
  community        Float?
  network          Float?
  achievement      Float?
  satisfaction     Float?
  balance          Float?
  health           Float?

  // Brain Talents (18 talentos del modelo Six Seconds)
  dataMining       Float?
  modeling         Float?
  prioritizing     Float?
  connection       Float?
  emotionalInsight Float?
  collaboration    Float?
  reflecting       Float?
  adaptability     Float?
  criticalThinking Float?
  resilience       Float?
  riskTolerance    Float?
  imagination      Float?
  proactivity      Float?
  commitment       Float?
  problemSolving   Float?
  vision           Float?
  designing        Float?
  entrepreneurship Float?
  brainAgility     Float?  // Score agregado de agilidad cerebral

  // Profile y otros
  brainStyle       String?
  profile          String?

  // Quality indicators
  reliabilityIndex Float?

  createdAt DateTime @default(now())

  benchmark Benchmark @relation(fields: [benchmarkId], references: [id], onDelete: Cascade)

  @@index([benchmarkId, country, region])
  @@index([benchmarkId, sector])
  @@index([benchmarkId, tenantId])
  @@index([benchmarkId, jobRole])
  @@map("benchmark_data_point")
}

/// Top Performer ‚Äî Patrones de los mejores en cada outcome
model BenchmarkTopPerformer {
  id          String   @id @default(cuid())
  benchmarkId String

  // Filtros de contexto
  country     String?
  region      String?
  sector      String?
  jobRole     String?
  ageRange    String?
  tenantId    String?

  // Outcome objetivo (qu√© queremos lograr)
  outcomeKey  String   // effectiveness, health, relationships, etc.

  // Definici√≥n de "top performer"
  percentileThreshold Int @default(90)  // Top 10%
  sampleSize  Int      @default(0)

  // Perfil promedio de los top performers
  avgK        Float?
  avgC        Float?
  avgG        Float?
  avgEL       Float?
  avgRP       Float?
  avgACT      Float?
  avgNE       Float?
  avgIM       Float?
  avgOP       Float?
  avgEMP      Float?
  avgNG       Float?

  // Competencias distintivas (ordenadas por importancia)
  topCompetencies     Json?   // [{key: "OP", avgScore, importance, diffFromAvg}]
  topTalents          Json?   // [{key: "proactivity", avgScore, importance}] - 18 en orden cluster
  topTalentsSummary   Json?   // Top 5 talentos m√°s distintivos

  // Patrones recurrentes
  commonPatterns      Json?   // Combinaciones de competencias que se repiten
  talentPatterns      Json?   // Combinaciones de talentos que se repiten

  calculatedAt DateTime @default(now())

  benchmark Benchmark @relation(fields: [benchmarkId], references: [id], onDelete: Cascade)

  @@unique([benchmarkId, outcomeKey, country, region, sector, jobRole, ageRange, tenantId])
  @@index([benchmarkId, outcomeKey])
  @@map("benchmark_top_performer")
}

/// Correlaci√≥n ‚Äî Relaci√≥n entre competencia y outcome
model BenchmarkCorrelation {
  id            String   @id @default(cuid())
  benchmarkId   String

  // Contexto
  country       String?
  region        String?
  sector        String?
  tenantId      String?

  // Relaci√≥n
  competencyKey String   // K, C, G, EL, RP, etc.
  outcomeKey    String   // effectiveness, health, etc.

  // Estad√≠sticas
  correlation   Float    // Pearson r (-1 a 1)
  pValue        Float?   // Significancia estad√≠stica
  n             Int      @default(0)

  // Interpretaci√≥n
  strength      String?  // strong, moderate, weak
  direction     String?  // positive, negative

  calculatedAt  DateTime @default(now())

  benchmark Benchmark @relation(fields: [benchmarkId], references: [id], onDelete: Cascade)

  @@unique([benchmarkId, competencyKey, outcomeKey, country, region, sector, tenantId])
  @@index([benchmarkId, outcomeKey])
  @@map("benchmark_correlation")
}

/// Outcome Pattern ‚Äî Mapas de √©xito emocional
model BenchmarkOutcomePattern {
  id          String   @id @default(cuid())
  benchmarkId String

  outcomeKey  String   // El outcome que queremos lograr

  // Contexto
  country     String?
  region      String?
  sector      String?
  tenantId    String?

  // El patr√≥n descubierto
  patternName        String?   // "El Optimista Emp√°tico", etc.
  patternDescription String?

  // Competencias clave (en orden de importancia)
  keyCompetencies    Json      // [{key, weight, minThreshold}]
  keyTalents         Json?     // [{key, weight}]

  // M√©tricas
  sampleSize         Int       @default(0)
  avgOutcomeScore    Float?
  successRate        Float?    // % que logran alto outcome con este patr√≥n

  confidence         Float?    // Confianza estad√≠stica

  calculatedAt DateTime @default(now())

  benchmark Benchmark @relation(fields: [benchmarkId], references: [id], onDelete: Cascade)

  @@index([benchmarkId, outcomeKey])
  @@map("benchmark_outcome_pattern")
}

/// Estad√≠sticas ‚Äî Pre-calculadas por filtros
model BenchmarkStatistic {
  id          String   @id @default(cuid())
  benchmarkId String

  // Filtros
  country     String?
  region      String?
  sector      String?
  jobRole     String?
  ageRange    String?
  gender      String?
  education   String?
  tenantId    String?

  // M√©trica
  metricKey   String

  // Estad√≠sticas
  n           Int      @default(0)
  mean        Float?
  median      Float?
  stdDev      Float?
  min         Float?
  max         Float?
  p10         Float?
  p25         Float?
  p50         Float?
  p75         Float?
  p90         Float?
  p95         Float?

  calculatedAt DateTime @default(now())

  benchmark Benchmark @relation(fields: [benchmarkId], references: [id], onDelete: Cascade)

  @@unique([benchmarkId, metricKey, country, region, sector, jobRole, ageRange, gender, education, tenantId])
  @@index([benchmarkId, metricKey])
  @@map("benchmark_statistic")
}

/// User Comparison ‚Äî Comparaci√≥n individual guardada
model BenchmarkUserComparison {
  id          String   @id @default(cuid())
  benchmarkId String
  userId      String?
  memberId    String?

  // Outcome buscado
  targetOutcome String  // effectiveness, health, etc.

  // Contexto usado para comparar
  comparisonContext Json  // {country, region, sector, etc.}
  fallbackUsed      String? // null, "region", "global"

  // Fortalezas del usuario (lo que YA tiene)
  userStrengths     Json    // [{competency, score, percentile, vsTopPerformer}]

  // C√≥mo los top performers usan fortalezas similares
  topPerformerInsights Json  // [{strength, howTheyUseIt, resultTheyGet}]

  // Qu√© desarrollar (apalancado en fortalezas)
  developmentAreas  Json    // [{area, priority, leveragedBy, actionSuggestion}]

  // Puntajes comparativos
  userScores        Json
  benchmarkScores   Json
  percentiles       Json

  // Resumen generado
  summaryInsight    String?

  createdAt DateTime @default(now())

  benchmark Benchmark @relation(fields: [benchmarkId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([memberId])
  @@map("benchmark_user_comparison")
}

/// Upload Job ‚Äî Procesamiento de archivos
model BenchmarkUploadJob {
  id           String    @id @default(cuid())
  benchmarkId  String?

  status       String    @default("pending")
  progress     Int       @default(0)
  currentPhase String?

  totalRows     Int      @default(0)
  processedRows Int      @default(0)
  failedRows    Int      @default(0)

  errorMessage String?
  errorDetails Json?

  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())

  @@index([status])
  @@map("benchmark_upload_job")
}

/// üåê RowiVerse Contribution ‚Äî Registro de cada contribuci√≥n de data EQ al benchmark global
model RowiVerseContribution {
  id          String   @id @default(cuid())

  // Qui√©n contribuy√≥
  userId      String?  // Usuario de Rowi (si aplica)
  memberId    String?  // CommunityMember (si es data de CSV)
  tenantId    String?  // Tenant de origen

  // A qu√© benchmark se contribuy√≥
  benchmarkId String   // El benchmark ROWIVERSE global
  dataPointId String?  // El BenchmarkDataPoint creado

  // Tipo de contribuci√≥n
  sourceType  String   // "registration", "csv_upload", "eq_snapshot", "manual"
  sourceId    String?  // ID del registro fuente (EqSnapshot, CsvUpload, etc.)

  // Datos contribuidos (anonimizados)
  eqTotal     Float?
  K           Float?
  C           Float?
  G           Float?

  // Demographics (anonimizados)
  country     String?
  region      String?
  sector      String?
  jobFunction String?
  ageRange    String?
  gender      String?

  // Estado
  status      String   @default("pending")  // pending, processed, rejected
  processedAt DateTime?

  createdAt   DateTime @default(now())

  @@index([benchmarkId])
  @@index([userId])
  @@index([memberId])
  @@index([tenantId])
  @@index([status])
  @@map("rowiverse_contribution")
}

// =========================================================
// üí≥ STRIPE & PAGOS
// =========================================================

/// üí≥ Suscripci√≥n de usuario con Stripe
model Subscription {
  id          String   @id @default(cuid())
  userId      String
  planId      String

  // Stripe IDs
  stripeSubscriptionId String  @unique
  stripePriceId        String
  stripeCustomerId     String

  // Estado
  status       SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean @default(false)
  cancelledAt        DateTime?

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@map("subscription")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  UNPAID
  TRIALING
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAUSED
}

/// üí∞ Historial de pagos
model Payment {
  id          String   @id @default(cuid())
  userId      String

  // Stripe IDs
  stripePaymentIntentId String? @unique
  stripeInvoiceId       String? @unique
  stripeChargeId        String?

  // Detalles
  amountCents  Int
  currency     String   @default("usd")
  status       PaymentStatus @default(PENDING)
  description  String?

  // Metadata
  metadata     Json?
  receiptUrl   String?
  invoiceUrl   String?

  paidAt       DateTime?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([status])
  @@map("payment")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

/// üéÅ Cupones y descuentos
model Coupon {
  id          String   @id @default(cuid())
  code        String   @unique

  // Tipo de descuento
  discountType    CouponType @default(PERCENTAGE)
  discountValue   Float      // Porcentaje o monto fijo

  // Restricciones
  maxUses         Int?       // Usos m√°ximos totales
  usedCount       Int        @default(0)
  maxUsesPerUser  Int        @default(1)
  minAmountCents  Int?       // Monto m√≠nimo para aplicar

  // Planes v√°lidos (null = todos)
  validPlanIds    String[]   @default([])

  // Vigencia
  startsAt        DateTime   @default(now())
  expiresAt       DateTime?

  // Estado
  active          Boolean    @default(true)

  // Stripe
  stripeCouponId  String?    @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  redemptions CouponRedemption[]

  @@map("coupon")
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_TRIAL_DAYS
}

/// üéüÔ∏è Redenci√≥n de cupones
model CouponRedemption {
  id       String   @id @default(cuid())
  couponId String
  userId   String

  // Contexto
  subscriptionId String?
  paymentId      String?

  // Valores aplicados
  discountApplied Float

  redeemedAt DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id])

  @@unique([couponId, userId])
  @@map("coupon_redemption")
}

// =========================================================
// üß† SIX SECONDS INTEGRATION
// =========================================================

/// üì§ Cola de solicitudes SEI pendientes
model SeiRequest {
  id          String   @id @default(cuid())
  userId      String

  // Datos del usuario para Six Seconds
  email       String
  name        String
  country     String?
  language    String   @default("es")

  // Link directo al SEI (proporcionado por Six Seconds)
  seiLink     String?              // Link para tomar el SEI directamente

  // Estado
  status      SeiRequestStatus @default(PENDING)

  // Six Seconds
  sixSecondsProjectId String?     // Proyecto en Six Seconds donde se envi√≥
  sixSecondsEmail     String?     // Email enviado por Six Seconds

  // Tracking
  requestedAt  DateTime @default(now())
  sentAt       DateTime?           // Cuando se envi√≥ a Six Seconds (manual)
  startedAt    DateTime?           // Cuando el usuario empez√≥ el SEI
  completedAt  DateTime?           // Cuando se recibi√≥ el resultado
  expiresAt    DateTime?           // Fecha l√≠mite para completar

  // Resultado (cuando se importa)
  resultSnapshotId String?         // EqSnapshot creado con el resultado

  // Notas admin
  adminNotes   String?
  processedBy  String?             // Email del admin que proces√≥

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([email])
  @@map("sei_request")
}

enum SeiRequestStatus {
  PENDING          // Esperando env√≠o a Six Seconds
  SENT             // Enviado a Six Seconds (link enviado al usuario)
  IN_PROGRESS      // Usuario est√° completando el SEI
  COMPLETED        // SEI completado, resultados recibidos
  EXPIRED          // Expir√≥ sin completar
  CANCELLED        // Cancelado por el usuario o admin
}

/// üì• Importaci√≥n de CSV de Six Seconds
model SixSecondsImport {
  id          String   @id @default(cuid())

  // Archivo
  filename    String
  fileSize    Int

  // Procesamiento
  status      SixSecondsImportStatus @default(PENDING)
  totalRows   Int      @default(0)
  processedRows Int    @default(0)
  matchedUsers  Int    @default(0)   // Usuarios encontrados en Rowi
  newSnapshots  Int    @default(0)   // EqSnapshots creados
  activatedUsers Int   @default(0)   // Usuarios activados (PENDING_SEI -> ACTIVE)

  // Errores
  failedRows  Int      @default(0)
  errors      Json?                   // Array de errores detallados

  // Admin
  uploadedBy  String                  // Email del admin
  processedAt DateTime?

  createdAt DateTime @default(now())

  @@index([status])
  @@map("six_seconds_import")
}

enum SixSecondsImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIAL       // Completado con algunos errores
}

/// üîó Links SEI por idioma (configurables desde CMS)
model SeiLink {
  id          String   @id @default(cuid())

  // Identificador √∫nico para el link
  code        String   @unique    // "default", "es-basic", "en-pro", etc.
  name        String              // Nombre descriptivo para el CMS

  // Link al SEI
  url         String              // URL completa del SEI en Six Seconds

  // Configuraci√≥n
  language    String   @default("es")  // Idioma del SEI
  planSlug    String?                   // Plan asociado (null = todos)
  isDefault   Boolean  @default(false) // Link por defecto para el idioma

  // Tracking Six Seconds
  sixSecondsProjectId String?     // ID del proyecto en Six Seconds

  // Estado
  isActive    Boolean  @default(true)

  // Meta
  description String?             // Descripci√≥n interna
  notes       String?             // Notas para admins

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([language])
  @@index([isActive])
  @@map("sei_link")
}

/// üìù Contenido CMS editable (textos de onboarding, p√°ginas, etc.)
model CmsContent {
  id          String   @id @default(cuid())

  // Identificador √∫nico del contenido
  key         String              // "onboarding.welcome.title", "onboarding.step1.description"
  language    String   @default("es")

  // Contenido
  value       String   @db.Text    // El texto/HTML
  valueType   CmsValueType @default(TEXT)  // TEXT, HTML, MARKDOWN, JSON

  // Categor√≠a para organizar
  category    String?             // "onboarding", "pricing", "landing", etc.
  subcategory String?             // "step1", "step2", etc.

  // Metadata
  description String?             // Descripci√≥n para el admin
  placeholder String?             // Valor por defecto si est√° vac√≠o

  // Estado
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, language])
  @@index([category])
  @@index([language])
  @@map("cms_content")
}

enum CmsValueType {
  TEXT
  HTML
  MARKDOWN
  JSON
}

/// üé® Configuraci√≥n de onboarding (pasos, colores, etc.)
model OnboardingConfig {
  id          String   @id @default(cuid())

  // Configuraci√≥n general
  key         String   @unique     // "general", "steps", "features", etc.
  config      Json                 // Configuraci√≥n JSON

  // Estado
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("onboarding_config")
}

// =========================================================
// üìä VENTAS Y FINANZAS
// =========================================================

/// üìà Registro de conversiones y fuentes de adquisici√≥n
model UserAcquisition {
  id          String   @id @default(cuid())
  userId      String   @unique

  // Fuente de adquisici√≥n
  source      AcquisitionSource @default(ORGANIC)
  channel     String?           // "google", "facebook", "referral", etc.
  campaign    String?           // Campa√±a espec√≠fica
  medium      String?           // "cpc", "email", "social", etc.

  // Referido
  referredBy  String?           // userId del referente
  referralCode String?          // C√≥digo de referido usado

  // Cup√≥n usado en registro
  couponCode  String?

  // UTM params
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?

  // Landing page
  landingPage String?

  // Conversiones
  registeredAt DateTime @default(now())
  convertedAt  DateTime?          // Cuando se convirti√≥ a pago

  // Valor
  lifetimeValueCents Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([source])
  @@index([referredBy])
  @@map("user_acquisition")
}

enum AcquisitionSource {
  ORGANIC
  PAID_SEARCH
  PAID_SOCIAL
  REFERRAL
  EMAIL
  DIRECT
  AFFILIATE
  PARTNER
  EVENT
  OTHER
}

/// üíµ Comisiones de referidos
model ReferralCommission {
  id          String   @id @default(cuid())

  // Qui√©n refiri√≥
  referrerId  String

  // Qui√©n fue referido
  referredUserId String

  // Pago que gener√≥ la comisi√≥n
  paymentId   String?

  // Comisi√≥n
  commissionCents Int
  commissionRate  Float           // Porcentaje de comisi√≥n (ej: 0.20 = 20%)

  // Estado
  status      CommissionStatus @default(PENDING)

  // Pago de la comisi√≥n
  paidAt      DateTime?
  payoutId    String?           // Referencia al pago

  createdAt DateTime @default(now())

  @@index([referrerId])
  @@index([status])
  @@map("referral_commission")
}

enum CommissionStatus {
  PENDING     // Esperando que pase el per√≠odo de reembolso
  APPROVED    // Aprobada, lista para pago
  PAID        // Pagada
  CANCELLED   // Cancelada (ej: reembolso del referido)
}

/// üìä M√©tricas de ventas agregadas (por d√≠a/mes)
model SalesMetric {
  id          String   @id @default(cuid())

  // Per√≠odo
  date        DateTime @db.Date
  period      MetricPeriod @default(DAILY)

  // M√©tricas de usuarios
  newUsers           Int @default(0)
  newTrials          Int @default(0)
  trialConversions   Int @default(0)
  churned            Int @default(0)

  // M√©tricas de ingresos (en centavos)
  mrrCents           Int @default(0)   // Monthly Recurring Revenue
  newMrrCents        Int @default(0)   // MRR de nuevos clientes
  expansionMrrCents  Int @default(0)   // MRR de upgrades
  churnedMrrCents    Int @default(0)   // MRR perdido por churn

  // M√©tricas de pagos
  totalPayments      Int @default(0)
  totalRevenueCents  Int @default(0)
  refundsCents       Int @default(0)

  // SEI
  seiRequests        Int @default(0)
  seiCompleted       Int @default(0)

  createdAt DateTime @default(now())

  @@unique([date, period])
  @@index([date])
  @@map("sales_metric")
}

enum MetricPeriod {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

/// =========================================================
/// üé® LANDING PAGE BUILDER ‚Äî Secciones visuales de la landing
/// =========================================================
/// Sistema de CMS visual estilo Elementor para construir la landing page.
/// Cada secci√≥n tiene un tipo, orden, configuraci√≥n visual y contenido traducible.

model LandingSection {
  id          String   @id @default(cuid())
  
  // Tipo de secci√≥n (hero, features, testimonials, pricing, etc.)
  type        LandingSectionType
  
  // Orden en la p√°gina (0, 1, 2...)
  order       Int      @default(0)
  
  // Visibilidad
  isVisible   Boolean  @default(true)
  
  // Configuraci√≥n visual (colores, espaciado, animaciones, etc.)
  config      Json?    // { bgColor, padding, animation, columns, etc. }
  
  // Contenido por idioma { es: {...}, en: {...} }
  content     Json     // Estructura depende del tipo
  
  // Metadatos
  name        String?  // Nombre interno para el admin
  description String?  // Descripci√≥n interna
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([order])
  @@index([type])
  @@map("landing_section")
}

enum LandingSectionType {
  NAVBAR
  HERO
  FEATURES
  HOW_IT_WORKS
  TESTIMONIALS
  PRICING
  CTA
  STATS
  FAQ
  LOGOS
  FOOTER
  CUSTOM
}

/// üñºÔ∏è Media Library para el Landing Builder
model LandingMedia {
  id          String   @id @default(cuid())

  // URL del archivo (puede ser local o CDN)
  url         String

  // Tipo de media
  type        String   @default("image") // image, video, icon

  // Metadatos
  name        String
  alt         String?
  width       Int?
  height      Int?
  size        Int?     // bytes

  // Etiquetas para organizar
  tags        String[] @default([])

  createdAt   DateTime @default(now())

  @@map("landing_media")
}

// ============================================
// üéÆ GAMIFICACI√ìN
// ============================================

/// üèÜ Definici√≥n de logros/achievements disponibles
model Achievement {
  id          String   @id @default(cuid())

  // Identificador √∫nico del logro (ej: "first_chat", "eq_master")
  slug        String   @unique

  // Informaci√≥n del logro
  name        String                    // Nombre en espa√±ol
  nameEN      String?                   // Nombre en ingl√©s
  description String                    // Descripci√≥n en espa√±ol
  descriptionEN String?                 // Descripci√≥n en ingl√©s

  // Visual
  icon        String?                   // Nombre del icono (lucide) o URL
  color       String   @default("#8B5CF6") // Color del badge

  // Categor√≠a
  category    AchievementCategory @default(GENERAL)

  // Requisitos
  requirement AchievementRequirement    // Tipo de requisito
  threshold   Int      @default(1)      // Cantidad requerida

  // Puntos que otorga
  points      Int      @default(10)

  // Nivel de dificultad/rareza
  rarity      AchievementRarity @default(COMMON)

  // Estado
  isActive    Boolean  @default(true)

  // Orden de display
  order       Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  userAchievements UserAchievement[]

  @@map("achievements")
}

/// üéñÔ∏è Logros obtenidos por usuarios
model UserAchievement {
  id            String   @id @default(cuid())

  userId        String
  achievementId String

  // Progreso (para logros graduales)
  progress      Int      @default(0)      // Progreso actual
  completed     Boolean  @default(false)  // ¬øCompletado?
  completedAt   DateTime?                 // Fecha de completado

  // Notificaci√≥n
  notified      Boolean  @default(false)  // ¬øYa se notific√≥ al usuario?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

/// üí∞ Puntos del usuario (historial)
model UserPoints {
  id          String   @id @default(cuid())

  userId      String

  // Puntos
  amount      Int                        // Cantidad de puntos (+/-)
  balance     Int                        // Balance despu√©s de esta transacci√≥n

  // Raz√≥n
  reason      PointsReason               // Tipo de transacci√≥n
  reasonId    String?                    // ID relacionado (achievementId, etc.)
  description String?                    // Descripci√≥n adicional

  createdAt   DateTime @default(now())

  // Relaciones
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("user_points")
}

/// üî• Rachas de actividad (streaks)
model UserStreak {
  id          String   @id @default(cuid())

  userId      String   @unique

  // Racha actual
  currentStreak Int    @default(0)       // D√≠as consecutivos actuales
  longestStreak Int    @default(0)       // Racha m√°s larga hist√≥rica

  // Control de racha
  lastActivityDate DateTime?             // √öltima fecha de actividad
  streakStartDate  DateTime?             // Inicio de la racha actual

  // Bonus por racha
  multiplier    Float  @default(1.0)     // Multiplicador de puntos por racha

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_streaks")
}

/// üìä Nivel del usuario
model UserLevel {
  id          String   @id @default(cuid())

  userId      String   @unique

  // Nivel actual
  level       Int      @default(1)

  // Puntos totales acumulados
  totalPoints Int      @default(0)

  // Puntos para el siguiente nivel
  pointsToNextLevel Int @default(100)

  // T√≠tulo del nivel
  title       String?                    // Ej: "Explorador Emocional"
  titleEN     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_levels")
}

// Enums de gamificaci√≥n
enum AchievementCategory {
  GENERAL           // Logros generales
  CHAT              // Logros de conversaciones con Rowi
  EQ                // Logros relacionados con EQ
  COMMUNITY         // Logros de comunidad
  LEARNING          // Logros de aprendizaje
  SOCIAL            // Logros sociales
  STREAK            // Logros de rachas
  SPECIAL           // Logros especiales/eventos
}

enum AchievementRequirement {
  CHAT_COUNT        // N√∫mero de chats
  CHAT_STREAK       // D√≠as consecutivos chateando
  EQ_SCORE          // Puntuaci√≥n EQ m√≠nima
  EQ_IMPROVEMENT    // Mejora en EQ
  PROFILE_COMPLETE  // Perfil completado
  COMMUNITY_JOIN    // Unirse a comunidad
  COMMUNITY_POST    // Publicar en comunidad
  INVITE_ACCEPTED   // Invitaciones aceptadas
  COURSE_COMPLETE   // Cursos completados
  DAYS_ACTIVE       // D√≠as activo
  FIRST_ACTION      // Primera acci√≥n de algo
  CUSTOM            // Requisito personalizado
}

enum AchievementRarity {
  COMMON            // Com√∫n (f√°cil de obtener)
  UNCOMMON          // Poco com√∫n
  RARE              // Raro
  EPIC              // √âpico
  LEGENDARY         // Legendario
}

enum PointsReason {
  ACHIEVEMENT       // Logro completado
  DAILY_LOGIN       // Login diario
  CHAT              // Conversaci√≥n con Rowi
  POST              // Publicaci√≥n
  COMMENT           // Comentario
  STREAK_BONUS      // Bonus por racha
  REFERRAL          // Referido
  COURSE            // Completar curso
  ADMIN_GRANT       // Otorgado por admin
  ADMIN_DEDUCT      // Deducido por admin
  MICRO_LEARNING    // Completar micro-learning
}

/// =========================================================
/// üìö MICROLEARNING ‚Äî Micro-acciones de Six Seconds
/// =========================================================
/// Contenido de microlearning basado en competencias EQ,
/// outcomes, brain talents y el modelo Six Seconds.
model MicroLearning {
  id          String   @id @default(cuid())
  slug        String   @unique              // "EEL_action_1", "INFLUENCE_action_2"

  // Categorizaci√≥n
  category    MicroLearningCategory         // competency | outcome | brain_talent | core_outcome
  parentKey   String                        // "EEL" | "INFLUENCE" | "BBE" | "EFFECTIVENESS"

  // Contenido
  title       String                        // T√≠tulo en espa√±ol
  titleEN     String?                       // T√≠tulo en ingl√©s
  description String?                       // Descripci√≥n detallada
  descriptionEN String?                     // Descripci√≥n en ingl√©s
  content     Json?                         // Contenido estructurado adicional

  // Metadata
  duration    Int      @default(2)          // Duraci√≥n estimada en minutos
  difficulty  MicroLearningDifficulty @default(BEGINNER)
  order       Int      @default(0)          // Orden dentro de su categor√≠a
  points      Int      @default(10)         // Puntos que otorga al completar

  // Estado
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)      // Destacado

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  userProgress UserMicroLearning[]

  @@index([category, parentKey])
  @@index([isActive])
  @@map("micro_learning")
}

/// üìä Progreso de MicroLearning por usuario
model UserMicroLearning {
  id              String   @id @default(cuid())

  userId          String
  microLearningId String

  // Progreso
  status          MicroLearningStatus @default(NOT_STARTED)
  progress        Int      @default(0)        // 0-100
  completedAt     DateTime?

  // Feedback
  rating          Int?                         // 1-5 estrellas
  notes           String?                      // Notas del usuario
  reflection      String?                      // Reflexi√≥n personal

  // Gamificaci√≥n
  pointsEarned    Int      @default(0)

  // Tracking
  startedAt       DateTime?
  lastAccessAt    DateTime?
  timeSpentSecs   Int      @default(0)        // Tiempo total invertido

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  microLearning   MicroLearning @relation(fields: [microLearningId], references: [id], onDelete: Cascade)

  @@unique([userId, microLearningId])
  @@index([userId, status])
  @@index([microLearningId])
  @@map("user_micro_learning")
}

/// üéÅ Recompensas canjeables
model Reward {
  id          String   @id @default(cuid())
  slug        String   @unique              // "premium_badge", "discount_10"

  // Informaci√≥n
  name        String                        // Nombre en espa√±ol
  nameEN      String?                       // Nombre en ingl√©s
  description String?                       // Descripci√≥n
  descriptionEN String?

  // Visual
  icon        String?                       // Icono (lucide o URL)
  image       String?                       // Imagen de la recompensa
  color       String   @default("#10B981")  // Color del reward

  // Costo y tipo
  cost        Int                           // Puntos necesarios para canjear
  type        RewardType                    // badge | feature | discount | physical | certificate

  // Disponibilidad
  stock       Int?                          // null = ilimitado
  maxPerUser  Int      @default(1)          // M√°ximo por usuario
  expiresAt   DateTime?                     // Fecha de expiraci√≥n

  // Estado
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)

  // Metadata adicional
  metadata    Json?                         // Datos espec√≠ficos del tipo de reward

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  claims      UserReward[]

  @@index([type, isActive])
  @@map("reward")
}

/// üèÜ Recompensas reclamadas por usuarios
model UserReward {
  id          String   @id @default(cuid())

  userId      String
  rewardId    String

  // Estado
  status      RewardClaimStatus @default(CLAIMED)
  claimedAt   DateTime @default(now())
  redeemedAt  DateTime?                     // Cuando se us√≥ (si aplica)
  expiresAt   DateTime?                     // Expiraci√≥n individual

  // Tracking
  metadata    Json?                         // Datos adicionales (c√≥digo de descuento, etc.)

  // Relaciones
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reward      Reward   @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([rewardId])
  @@map("user_reward")
}

/// üß† Knowledge Deployment ‚Äî Despliegue de conocimiento a agentes IA
model AgentKnowledgeDeployment {
  id          String   @id @default(cuid())

  agentId     String

  // Fuente y tipo
  source      KnowledgeSource               // manual | auto_learned | six_seconds | conversation
  contentType KnowledgeContentType          // outcome | competency | brain_talent | micro_action | pattern | custom
  contentKey  String                        // "INFLUENCE" | "EEL" | "BBE" | etc.

  // Contenido
  title       String?                       // T√≠tulo descriptivo
  content     Json                          // El contenido completo (JSON)
  summary     String?                       // Resumen para quick reference

  // Estado de deployment
  status      KnowledgeDeploymentStatus @default(PENDING)
  deployedAt  DateTime?
  deployedBy  String?                       // userId del admin que aprob√≥

  // M√©tricas de uso
  usageCount  Int      @default(0)          // Veces que se ha usado
  lastUsedAt  DateTime?
  effectiveness Float?                      // 0-1 basado en feedback

  // Metadata
  tags        String[] @default([])
  metadata    Json?                         // Datos adicionales

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  agent       AgentConfig @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, contentType, contentKey])
  @@index([agentId, status])
  @@index([contentType, contentKey])
  @@map("agent_knowledge_deployment")
}

/// üìà Definici√≥n de Niveles del sistema de gamificaci√≥n
model LevelDefinition {
  id              String   @id @default(cuid())

  level           Int      @unique           // 1, 2, 3...

  // Requisitos
  minPoints       Int                        // Puntos m√≠nimos para este nivel
  maxPoints       Int?                       // Puntos m√°ximos (null para el √∫ltimo nivel)

  // T√≠tulos
  title           String                     // "Explorador Emocional"
  titleEN         String?                    // "Emotional Explorer"
  description     String?
  descriptionEN   String?

  // Visual
  icon            String?                    // Icono del nivel
  color           String   @default("#8B5CF6")
  badge           String?                    // Badge/imagen del nivel

  // Beneficios
  benefits        Json?                      // Lista de beneficios desbloqueados
  multiplier      Float    @default(1.0)     // Multiplicador de puntos

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("level_definition")
}

// =========================================================
// üè∑Ô∏è ENUMS para MicroLearning y Gamificaci√≥n extendida
// =========================================================

enum MicroLearningCategory {
  COMPETENCY      // Competencias EQ (EEL, RP, ACT, etc.)
  OUTCOME         // Outcomes (Influence, Decision Making, etc.)
  BRAIN_TALENT    // Brain Talents (BBE, BBI, etc.)
  CORE_OUTCOME    // Core Outcomes (Effectiveness, Wellbeing, etc.)
}

enum MicroLearningDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum MicroLearningStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum RewardType {
  BADGE           // Badge visual
  FEATURE         // Acceso a feature premium
  DISCOUNT        // Descuento
  PHYSICAL        // Producto f√≠sico
  CERTIFICATE     // Certificado digital
  TOKENS          // Tokens de IA adicionales
}

enum RewardClaimStatus {
  CLAIMED         // Reclamado
  REDEEMED        // Usado/canjeado
  EXPIRED         // Expirado
  REVOKED         // Revocado
}

enum KnowledgeSource {
  MANUAL          // Subido manualmente por admin
  AUTO_LEARNED    // Aprendido de conversaciones
  SIX_SECONDS     // Contenido de Six Seconds
  CONVERSATION    // Extra√≠do de chat espec√≠fico
  IMPORT          // Importado de archivo
}

enum KnowledgeContentType {
  OUTCOME         // Outcomes de Six Seconds
  COMPETENCY      // Competencias EQ
  BRAIN_TALENT    // Brain Talents
  CORE_OUTCOME    // Core Outcomes
  MICRO_ACTION    // Micro-acciones espec√≠ficas
  PATTERN         // Patr√≥n aprendido
  CUSTOM          // Contenido personalizado
}

enum KnowledgeDeploymentStatus {
  PENDING         // Pendiente de aprobaci√≥n
  APPROVED        // Aprobado, listo para deploy
  DEPLOYED        // Desplegado y activo
  REJECTED        // Rechazado
  ARCHIVED        // Archivado (ya no activo)
}

// =========================================================
// üìÖ WEEKFLOW - Check-ins Semanales de Equipo
// =========================================================

model WeekFlowConfig {
  id        String   @id @default(cuid())

  // Scope (puede ser a nivel tenant, hub, o global)
  tenantId  String?
  hubId     String?

  // Configuraci√≥n
  name      String   @default("WeekFlow")
  isActive  Boolean  @default(true)

  // Secciones habilitadas
  enableShowTell    Boolean @default(true)
  enableToDiscuss   Boolean @default(true)
  enableFocus       Boolean @default(true)
  enableTasks       Boolean @default(true)
  enableMoodCheckin Boolean @default(true)

  // Configuraci√≥n de check-in
  requireMoodCheckin Boolean @default(true)
  moodReminderDay    Int     @default(1)     // 1=Lunes
  moodReminderTime   String  @default("09:00")

  // Gamificaci√≥n
  pointsPerCheckin      Int @default(15)
  pointsPerContribution Int @default(10)
  pointsPerTaskComplete Int @default(5)

  // L√≠mites
  maxItemsPerSection       Int @default(10)
  maxTasksPerMember        Int @default(20)
  daysBeforeTaskReflection Int @default(7)

  // Integraciones
  slackWebhook    String?
  googleDocsId    String?
  emailReminders  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant    Tenant?            @relation(fields: [tenantId], references: [id])
  hub       Hub?               @relation(fields: [hubId], references: [id])
  sessions  WeekFlowSession[]

  @@unique([tenantId, hubId])
  @@index([tenantId])
  @@index([hubId])
  @@map("weekflow_config")
}

model WeekFlowSession {
  id        String   @id @default(cuid())

  configId  String
  tenantId  String?
  hubId     String?

  // Identificaci√≥n de semana
  weekNumber Int      // ISO week number (1-53)
  year       Int
  weekStart  DateTime
  weekEnd    DateTime

  status    WeekFlowSessionStatus @default(ACTIVE)
  summary   String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  config        WeekFlowConfig         @relation(fields: [configId], references: [id], onDelete: Cascade)
  tenant        Tenant?                @relation(fields: [tenantId], references: [id])
  hub           Hub?                   @relation(fields: [hubId], references: [id])
  contributions WeekFlowContribution[]
  moodCheckins  WeekFlowMoodCheckin[]

  @@unique([configId, year, weekNumber])
  @@index([tenantId, year, weekNumber])
  @@index([hubId, year, weekNumber])
  @@index([weekStart])
  @@map("weekflow_session")
}

enum WeekFlowSessionStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

model WeekFlowContribution {
  id        String   @id @default(cuid())

  sessionId String
  userId    String

  type      WeekFlowContributionType
  content   String   @db.Text

  order     Int      @default(0)
  status    WeekFlowContributionStatus @default(ACTIVE)

  // Para Focus items que son tareas
  isTask      Boolean   @default(false)
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  dueDate     DateTime?
  priority    TaskPriority @default(MEDIUM)

  // Menciones a otros usuarios (@tags)
  mentions    String[]  @default([])  // Array de userIds mencionados

  reactions   Json?     // { "üëç": ["userId1"], "üéâ": ["userId2"] }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session   WeekFlowSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id])
  comments  WeekFlowComment[]

  @@index([sessionId, type])
  @@index([userId])
  @@index([sessionId, userId])
  @@map("weekflow_contribution")
}

enum WeekFlowContributionType {
  SHOW_TELL
  TO_DISCUSS
  FOCUS
}

enum WeekFlowContributionStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model WeekFlowMoodCheckin {
  id        String   @id @default(cuid())

  sessionId String
  userId    String

  // Emoci√≥n seleccionada (slug de la rueda progresiva)
  emotion   String      // Ej: "joy", "overwhelmed", "anxious"
  intensity Int         @default(5)  // 1-10

  note      String?     @db.Text

  createdAt DateTime @default(now())

  session   WeekFlowSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id])

  @@unique([sessionId, userId])
  @@index([userId])
  @@index([sessionId])
  @@map("weekflow_mood_checkin")
}

model WeekFlowComment {
  id             String   @id @default(cuid())
  contributionId String
  userId         String
  content        String   @db.Text
  mentions       String[] @default([])  // Array de userIds mencionados

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contribution WeekFlowContribution @relation(fields: [contributionId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id])

  @@index([contributionId])
  @@index([userId])
  @@map("weekflow_comment")
}

// =========================================================
// ‚úÖ ROWI TASKS - Tareas con Insights Emocionales
// =========================================================

model RowiTask {
  id        String   @id @default(cuid())

  userId    String
  tenantId  String?
  hubId     String?

  title       String
  description String? @db.Text

  status    RowiTaskStatus @default(TODO)
  priority  TaskPriority   @default(MEDIUM)

  dueDate     DateTime?
  completedAt DateTime?

  // Origen
  sourceType    String?   // "weekflow", "manual", "imported"
  sourceId      String?

  // Organizaci√≥n
  tags      String[]  @default([])
  category  String?

  // Recurrencia
  isRecurring   Boolean @default(false)
  recurringRule String?

  // Visibilidad
  visibility    TaskVisibility @default(PRIVATE)

  // Emotional insights (todo opcional)
  weekFlowSessionId   String?
  emotionAtCreation   String?   // Slug de emoci√≥n
  emotionAtCompletion String?
  incompletionReason  TaskIncompletionReason?
  incompletionNote    String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User             @relation(fields: [userId], references: [id])
  tenant      Tenant?          @relation(fields: [tenantId], references: [id])
  hub         Hub?             @relation(fields: [hubId], references: [id])
  reflections TaskReflection[]

  @@index([userId, status])
  @@index([tenantId])
  @@index([hubId])
  @@index([dueDate])
  @@map("rowi_task")
}

enum RowiTaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
  POSTPONED
  BLOCKED
}

enum TaskVisibility {
  PRIVATE
  TEAM
  HUB_ADMIN
}

enum TaskIncompletionReason {
  // Emocionales
  OVERWHELMED
  ANXIOUS
  UNMOTIVATED
  PERFECTIONISM
  FEAR_OF_FAILURE
  // Externos
  TIME_CONSTRAINT
  DEPENDENCY_BLOCKED
  PRIORITY_SHIFT
  UNCLEAR_TASK
  // Re-evaluaci√≥n
  NO_LONGER_NEEDED
  DELEGATED
  MERGED
  // Otros
  OTHER
}

model TaskReflection {
  id        String   @id @default(cuid())
  taskId    String
  userId    String

  type      ReflectionType

  emotion   String?   // Slug de emoci√≥n
  intensity Int?      @default(5)
  note      String?   @db.Text

  blockerType     String?
  suggestedAction String?

  createdAt DateTime @default(now())

  task      RowiTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
  @@map("task_reflection")
}

enum ReflectionType {
  CREATION
  POSTPONE
  BLOCK
  COMPLETION
  WEEKLY_REVIEW
}

// =========================================================
// üé® VOCABULARIO EMOCIONAL PROGRESIVO (Six Seconds)
// =========================================================

model EmotionVocabulary {
  id        String   @id @default(cuid())
  userId    String   @unique

  level     EmotionLevel @default(DESAFIO)

  unlockedEmotions   String[] @default([])
  totalCheckins      Int @default(0)
  uniqueEmotionsUsed Int @default(0)
  progressToNextLevel Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("emotion_vocabulary")
}

enum EmotionLevel {
  DESAFIO     // 8 emociones
  EMERGENTE   // 24 emociones
  FUNCIONAL   // 48 emociones
  DIESTRO     // 80 emociones
  EXPERTO     // 130+ emociones
}

// =========================================================
// üìä WEEKFLOW METRICS
// =========================================================

model WeekFlowMetrics {
  id        String   @id @default(cuid())

  tenantId  String?
  hubId     String?
  userId    String?

  periodType  MetricPeriod
  periodStart DateTime
  periodEnd   DateTime

  totalCheckins       Int @default(0)
  totalContributions  Int @default(0)
  totalTasks          Int @default(0)
  completedTasks      Int @default(0)

  avgMoodIntensity    Float?
  dominantEmotion     String?
  moodVariance        Float?

  commentCount        Int @default(0)
  reactionCount       Int @default(0)
  consecutiveWeeks    Int @default(0)

  taskCompletionRate  Float?
  participationRate   Float?

  createdAt DateTime @default(now())

  @@unique([tenantId, hubId, userId, periodType, periodStart])
  @@index([tenantId, periodType])
  @@index([hubId, periodType])
  @@index([userId, periodType])
  @@map("weekflow_metrics")
}

// MetricPeriodType fue unificado con MetricPeriod (ver arriba)


